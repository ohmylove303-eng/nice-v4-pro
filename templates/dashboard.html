<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NICE v4 PRO - ì „ë¬¸ê°€ ë ˆë²¨ AI ê±°ë˜ ì‹œìŠ¤í…œ</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap"
        rel="stylesheet">

    <style>
        /* ========== Mantine-Inspired Dark Theme Variables ========== */
        :root {
            /* Mantine Dark Color Scale */
            --mantine-color-dark-0: #c9c9c9;
            --mantine-color-dark-1: #b8b8b8;
            --mantine-color-dark-2: #828282;
            --mantine-color-dark-3: #696969;
            --mantine-color-dark-4: #424242;
            --mantine-color-dark-5: #3b3b3b;
            --mantine-color-dark-6: #2e2e2e;
            --mantine-color-dark-7: #242424;
            --mantine-color-dark-8: #1f1f1f;
            --mantine-color-dark-9: #141414;

            /* Mantine Primary (Blue) */
            --mantine-primary-0: #e7f5ff;
            --mantine-primary-5: #228be6;
            --mantine-primary-6: #1c7ed6;
            --mantine-primary-9: #1864ab;

            /* Mantine Teal (Success) */
            --mantine-teal-5: #12b886;
            --mantine-teal-6: #0ca678;

            /* Mantine Red (Error) */
            --mantine-red-5: #fa5252;
            --mantine-red-6: #f03e3e;

            /* Mantine Yellow (Warning) */
            --mantine-yellow-5: #fab005;
            --mantine-yellow-6: #f59f00;

            /* Mantine Grape (Accent) */
            --mantine-grape-5: #be4bdb;
            --mantine-grape-6: #ae3ec9;

            /* Mantine Cyan (Info) */
            --mantine-cyan-5: #15aabf;
            --mantine-cyan-6: #1098ad;
        }

        * {
            font-family: 'Noto Sans KR', sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--mantine-color-dark-9) 0%, var(--mantine-color-dark-7) 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        /* Type ë±ƒì§€ */
        .type-a {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .type-b {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .type-c {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .type-badge {
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 11px;
        }

        /* ë©”ì´ì €/ê¸°íƒ€ ë±ƒì§€ */
        .badge-major {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid #f87171;
        }

        .badge-other {
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid #fbbf24;
        }

        /* ========== NICE Score SVG ê²Œì´ì§€ ========== */
        .nice-gauge {
            width: 120px;
            height: 120px;
            transform: rotate(-90deg);
        }

        .nice-gauge .gauge-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 8;
        }

        .nice-gauge .gauge-fill {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.8s ease-out, stroke 0.3s;
        }

        .nice-gauge .gauge-fill.type-a {
            stroke: #10b981;
        }

        .nice-gauge .gauge-fill.type-b {
            stroke: #f59e0b;
        }

        .nice-gauge .gauge-fill.type-c {
            stroke: #ef4444;
        }

        .nice-gauge-container {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .nice-gauge-value {
            position: absolute;
            transform: rotate(0deg);
            font-size: 24px;
            font-weight: 700;
        }

        .nice-gauge-label {
            position: absolute;
            bottom: 15px;
            font-size: 10px;
            color: #9ca3af;
            transform: rotate(0deg);
        }

        /* ========== ìœ„í—˜ ê´€ë¦¬ í”„ë¡œê·¸ë ˆìŠ¤ ë°” ========== */
        .risk-progress {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .risk-progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease-out, background 0.3s;
        }

        .risk-low {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .risk-medium {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .risk-high {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        /* ========== ë°±í…ŒìŠ¤íŠ¸ ìš”ì•½ ========== */
        .backtest-summary {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 16px;
        }

        .backtest-stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .backtest-stat:last-child {
            border-bottom: none;
        }

        .backtest-stat-label {
            color: #9ca3af;
            font-size: 13px;
        }

        .backtest-stat-value {
            font-weight: 600;
        }

        .backtest-positive {
            color: #10b981;
        }

        .backtest-negative {
            color: #ef4444;
        }

        /* ì½”ì¸ ì¹´ë“œ */
        .coin-card {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .coin-card:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: #00d4ff;
            transform: translateY(-2px);
        }

        .coin-card.selected {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.15);
        }

        /* Market Map */
        .market-map-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-size: 10px;
            font-weight: 700;
            border-radius: 4px;
            padding: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .market-map-cell:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .market-map-cell.bullish {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .market-map-cell.bearish {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .market-map-cell.neutral {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }

        /* ëª¨ë‹¬ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a2e;
            border-radius: 16px;
            padding: 24px;
            max-width: 800px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        .score-bar-bg {
            background: rgba(0, 212, 255, 0.2);
            height: 5px;
            border-radius: 3px;
            overflow: hidden;
        }

        .fill-green {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .fill-yellow {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .fill-red {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }

        /* Flow ì•„ì´í…œ */
        .flow-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .flow-item:last-child {
            border-bottom: none;
        }

        /* ì§€í‘œ ë²„íŠ¼ */
        .indicator-btn {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .indicator-btn.active {
            background: rgba(16, 185, 129, 0.3);
            border: 1px solid #10b981;
        }

        .indicator-btn:not(.active) {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* ì¹´í…Œê³ ë¦¬ íƒ­ */
        .tab-btn {
            padding: 10px 16px;
            background: rgba(0, 212, 255, 0.15);
            border: 1px solid rgba(0, 212, 255, 0.3);
            color: #00d4ff;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab-btn.active {
            background: rgba(16, 185, 129, 0.4);
            border-color: #10b981;
            color: #10b981;
        }

        .tab-btn:hover {
            background: rgba(0, 212, 255, 0.25);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ========== NEW: Skeleton Loading Animation ========== */
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .skeleton {
            background: linear-gradient(90deg,
                    rgba(255, 255, 255, 0.03) 25%,
                    rgba(255, 255, 255, 0.08) 50%,
                    rgba(255, 255, 255, 0.03) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
            color: transparent !important;
        }

        .skeleton-text {
            height: 1em;
            min-width: 60px;
            display: inline-block;
        }

        /* ========== IMPROVED: Mobile Responsiveness ========== */
        @media (max-width: 640px) {
            .glass-card {
                padding: 12px;
            }

            .text-xs {
                font-size: 11px;
            }

            .text-sm {
                font-size: 13px;
            }

            /* Increase touch targets */
            .indicator-btn,
            .tab-btn {
                padding: 8px 14px;
                min-height: 36px;
            }

            /* Better spacing for analysis cards */
            #wave-analysis-panel .grid {
                gap: 12px;
            }

            /* Larger text in data fields */
            #ai-analysis-content .font-bold {
                font-size: 14px;
            }
        }

        /* ========== IMPROVED: Card Spacing ========== */
        .data-field {
            transition: all 0.3s ease;
        }

        .data-field.loading {
            opacity: 0.6;
        }

        .data-field.error {
            color: #f87171;
        }

        /* ========== IMPROVED: Better Visual Hierarchy ========== */
        .highlight-current {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.4);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* ========== NEW: Toast Notifications ========== */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(30, 30, 50, 0.95);
            border: 1px solid rgba(0, 212, 255, 0.3);
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-color: #10b981;
        }

        .toast.error {
            border-color: #ef4444;
        }

        .toast.warning {
            border-color: #f59e0b;
        }
    </style>
</head>

<body class="text-white">
    <div id="app" class="min-h-screen">

        <!-- í—¤ë” -->
        <header class="glass-card sticky top-0 z-50 mb-3" style="border-radius: 0;">
            <div class="container mx-auto px-3 py-2">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-3">
                        <h1 class="text-base font-black">ğŸ¯ NICE v4 PRO</h1>
                        <span id="main-type" class="type-badge type-a">Type A</span>
                        <span class="font-bold text-emerald-400" id="main-score">86ì </span>
                    </div>

                    <!-- ì½”ì¸ ê²€ìƒ‰ -->
                    <div class="relative flex-1 max-w-xs mx-4">
                        <div class="relative">
                            <input type="text" id="coin-search-input" placeholder="ğŸ” ì½”ì¸ ê²€ìƒ‰ (BTC, ETH, SOL...)"
                                class="w-full bg-gray-800/80 border border-gray-600 rounded-lg px-3 py-1.5 text-sm text-white placeholder-gray-400 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500"
                                autocomplete="off">
                            <button id="search-clear-btn"
                                class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white hidden">âœ•</button>
                        </div>
                        <div id="search-results"
                            class="absolute top-full left-0 right-0 bg-gray-900 border border-gray-700 rounded-lg mt-1 max-h-64 overflow-y-auto hidden z-50 shadow-xl">
                        </div>
                    </div>

                    <div class="flex items-center gap-3 text-xs">
                        <span class="pulse text-emerald-400">â— LIVE</span>
                        <span class="text-gray-400" id="last-update">18:40 ê°±ì‹ </span>
                    </div>
                </div>

                <!-- ìƒíƒœ ë°” -->
                <div class="grid grid-cols-3 md:grid-cols-6 gap-2 text-center text-xs">
                    <div class="glass-card p-2">
                        <div class="text-gray-400">ìµœê³  ì‹ í˜¸</div>
                        <div class="font-bold text-emerald-400" id="top-signal">BTC/ETH</div>
                    </div>
                    <div class="glass-card p-2">
                        <div class="text-gray-400">ğŸŸ¢ Type A</div>
                        <div class="font-bold" id="type-a-count">7ê°œ</div>
                    </div>
                    <div class="glass-card p-2">
                        <div class="text-gray-400">ë‹¤ìŒ ë¦¬í¬íŠ¸</div>
                        <div class="font-bold" id="next-report">19:00</div>
                    </div>
                    <div class="glass-card p-2">
                        <div class="text-gray-400">ì¶”ì²œ Kelly</div>
                        <div class="font-bold text-emerald-400" id="avg-kelly">3.1%</div>
                    </div>
                    <div class="glass-card p-2">
                        <div class="text-gray-400">Fear & Greed</div>
                        <div class="font-bold" id="fear-greed">55 íƒìš•</div>
                    </div>
                    <div class="glass-card p-2">
                        <div class="text-gray-400">Net Flow</div>
                        <div class="font-bold text-emerald-400" id="net-flow">+$2.4B</div>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-3 space-y-3">

            <!-- ì¹´í…Œê³ ë¦¬ íƒ­ -->
            <div class="flex gap-2 overflow-x-auto pb-2">
                <button class="tab-btn active" data-tab="scalp">ğŸ’¥ ë‹¨íƒ€ (5~30ë¶„)</button>
                <button class="tab-btn" data-tab="short">ğŸ“ˆ ë‹¨ê¸° (30ë¶„~2ì‹œê°„)</button>
                <button class="tab-btn" data-tab="medium">ğŸ”„ ì¤‘ê¸° (2ì‹œê°„~1ì¼)</button>
                <button class="tab-btn" data-tab="long">ğŸ“Š ì¥ê¸° (1ì¼~1ì£¼)</button>
                <button class="tab-btn" data-tab="bithumb" style="border-color: #f7931a; color: #f7931a;">ğŸ‡°ğŸ‡· ë¹—ì¸
                    ë¦¬ìŠ¤íŠ¸</button>
                <button class="tab-btn" data-tab="surge">ğŸš€ ì´ˆ ê¸‰ë“±</button>
                <button class="tab-btn" data-tab="report">ğŸ“‹ AI ë¦¬í¬íŠ¸</button>
                <button class="tab-btn" data-tab="analysis">ğŸ” ì‹œì¥ ì •ë°€ ë¶„ì„</button>
            </div>

            <!-- íƒ­ ì½˜í…ì¸  ì»¨í…Œì´ë„ˆ (í†µí•© ë·°) -->
            <div id="dashboard-view" class="tab-content active">
                <!-- ì°¨íŠ¸ + Market Map -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
                    <!-- TradingView ì°¨íŠ¸ -->
                    <div class="lg:col-span-2 glass-card p-3">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="font-bold" id="chart-symbol">BTC</span>
                                <span class="text-gray-400 text-sm" id="chart-name">Bitcoin</span>
                                <span class="text-emerald-400 font-bold" id="chart-price">$45,200</span>
                                <span class="text-emerald-400 text-sm" id="chart-change">+2.5%</span>
                            </div>
                            <div class="flex gap-1" id="timeframe-buttons">
                                <button class="indicator-btn active" data-tf="5">5M</button>
                                <button class="indicator-btn" data-tf="15">15M</button>
                                <button class="indicator-btn" data-tf="60">1H</button>
                                <button class="indicator-btn" data-tf="240">4H</button>
                                <button class="indicator-btn" data-tf="D">1D</button>
                            </div>
                        </div>
                        <div id="tradingview-chart"
                            style="height: 320px; background: rgba(0,0,0,0.3); border-radius: 8px; overflow: hidden;">
                            <!-- TradingView Widget -->
                            <div id="tv-widget-container" style="width: 100%; height: 100%;"></div>
                        </div>
                        <!-- ì§€í‘œ ë°” (í™•ì¥) -->
                        <div class="flex gap-2 mt-2 flex-wrap">
                            <span class="indicator-btn active">BB (20,2)</span>
                            <span class="indicator-btn active">RSI (14)</span>
                            <span class="indicator-btn active">MACD (12,26,9)</span>
                            <span class="indicator-btn active">EMA (20/50/200)</span>
                            <span class="indicator-btn active">Volume</span>
                            <span class="indicator-btn active">Stoch RSI</span>
                            <!-- ìƒˆ ì§€í‘œ: Elliott Wave, Fibonacci, Trendline -->
                            <span class="indicator-btn active"
                                style="background: rgba(147, 51, 234, 0.3); border-color: #a855f7;">ZigZag (íŒŒë™)</span>
                            <span class="indicator-btn active"
                                style="background: rgba(234, 179, 8, 0.3); border-color: #eab308;">Pivot (í”¼ë³´ë‚˜ì¹˜)</span>
                            <span class="indicator-btn active"
                                style="background: rgba(6, 182, 212, 0.3); border-color: #06b6d4;">Ichimoku (êµ¬ë¦„)</span>
                            <span class="indicator-btn active"
                                style="background: rgba(236, 72, 153, 0.3); border-color: #ec4899;">PSAR (ì¶”ì„¸)</span>
                        </div>

                        <!-- ========== Elliott Wave / Fibonacci / Trendline ë¶„ì„ íŒ¨ë„ (NEW) ========== -->
                        <div class="glass-card p-3 mt-3" id="wave-analysis-panel">
                            <h4 class="font-bold text-sm mb-3 flex items-center gap-2">
                                <span>ğŸ“</span> ê¸°ìˆ ì  íŒŒë™ ë¶„ì„
                                <span class="text-xs text-gray-400" id="wave-coin-name">(BTC)</span>
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                                <!-- Elliott Wave ë¶„ì„ -->
                                <div class="bg-gray-800/50 rounded-lg p-3 border-l-4 border-purple-500">
                                    <div class="text-purple-400 text-xs font-bold mb-2">ğŸŒŠ Elliott Wave</div>
                                    <div class="text-white font-bold text-lg mb-1" id="elliott-position">Wave 3 ìƒìŠ¹</div>
                                    <div class="text-xs text-gray-400" id="elliott-detail">
                                        5íŒŒ ìƒìŠ¹ ì¤‘ 3íŒŒ ì§„í–‰<br>
                                        ëª©í‘œ: 4íŒŒ ì¡°ì • í›„ 5íŒŒ ì‹ ê³ ê°€
                                    </div>
                                    <div class="mt-2 flex gap-1">
                                        <span
                                            class="px-2 py-0.5 bg-purple-500/20 text-purple-300 rounded text-xs">1</span>
                                        <span
                                            class="px-2 py-0.5 bg-purple-500/20 text-purple-300 rounded text-xs">2</span>
                                        <span class="px-2 py-0.5 bg-purple-500 text-white rounded text-xs font-bold"
                                            id="current-wave">3</span>
                                        <span class="px-2 py-0.5 bg-gray-700 text-gray-400 rounded text-xs">4</span>
                                        <span class="px-2 py-0.5 bg-gray-700 text-gray-400 rounded text-xs">5</span>
                                    </div>
                                </div>

                                <!-- Fibonacci ë ˆë²¨ -->
                                <div class="bg-gray-800/50 rounded-lg p-3 border-l-4 border-yellow-500">
                                    <div class="text-yellow-400 text-xs font-bold mb-2">ğŸ“Š Fibonacci Retracement</div>
                                    <div class="text-white font-bold mb-1" id="fib-position">61.8% ì§€ì§€ í…ŒìŠ¤íŠ¸</div>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">0.0% (ì €ì )</span>
                                            <span class="text-white" id="fib-0">$85,000</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">23.6%</span>
                                            <span class="text-gray-300" id="fib-236">$88,500</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">38.2%</span>
                                            <span class="text-gray-300" id="fib-382">$90,700</span>
                                        </div>
                                        <div class="flex justify-between bg-yellow-500/20 px-1 rounded">
                                            <span class="text-yellow-400 font-bold">50.0% â—€ í˜„ì¬</span>
                                            <span class="text-yellow-300 font-bold" id="fib-50">$92,500</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">61.8%</span>
                                            <span class="text-gray-300" id="fib-618">$94,300</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-400">100% (ê³ ì )</span>
                                            <span class="text-white" id="fib-100">$100,000</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Trendline ë¶„ì„ -->
                                <div class="bg-gray-800/50 rounded-lg p-3 border-l-4 border-cyan-500">
                                    <div class="text-cyan-400 text-xs font-bold mb-2">ğŸ“ˆ ì¶”ì„¸ì„  ë¶„ì„</div>
                                    <div class="text-white font-bold mb-1" id="trend-status">ìƒìŠ¹ ì¶”ì„¸ ìœ ì§€</div>
                                    <div class="space-y-2 text-xs">
                                        <div class="flex justify-between items-center">
                                            <span class="text-emerald-400">â–² ì£¼ìš” ì €í•­</span>
                                            <span class="text-emerald-300 font-bold"
                                                id="trend-resistance">$98,500</span>
                                        </div>
                                        <div class="flex justify-between items-center bg-cyan-500/20 px-1 rounded">
                                            <span class="text-cyan-400 font-bold">â—† í˜„ì¬ê°€</span>
                                            <span class="text-cyan-300 font-bold" id="trend-current">$92,500</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-red-400">â–¼ ì£¼ìš” ì§€ì§€</span>
                                            <span class="text-red-300 font-bold" id="trend-support">$88,000</span>
                                        </div>
                                        <div class="mt-2 pt-2 border-t border-gray-700">
                                            <div class="text-gray-400">ì¶”ì„¸ ê°•ë„</div>
                                            <div class="flex items-center gap-2 mt-1">
                                                <div class="flex-1 bg-gray-700 rounded-full h-2">
                                                    <div class="bg-gradient-to-r from-cyan-500 to-emerald-500 h-2 rounded-full"
                                                        id="trend-strength-bar" style="width: 72%"></div>
                                                </div>
                                                <span class="text-cyan-400 font-bold" id="trend-strength">72%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Market Map -->
                    <div class="glass-card p-3">
                        <h3 class="font-bold text-sm mb-2">ğŸ—ºï¸ ì‹œì¥ ì§€ë„ (Market Map)</h3>
                        <div class="grid grid-cols-4 gap-1" id="market-map" style="height: 320px; overflow-y: auto;">
                            <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                            <div class="text-center text-gray-500 py-10">ë¡œë”© ì¤‘...</div>
                        </div>
                    </div>
                </div>

                <!-- AI ë¶„ì„ íŒ¨ë„ -->
                <div class="glass-card p-3 mt-3" id="ai-analysis-panel">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-lg">ğŸ¤–</span>
                        <h3 class="font-bold">AI íˆ¬ì ë¶„ì„</h3>
                        <span class="text-xs text-gray-400" id="selected-coin-name">BTC Bitcoin</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 text-sm" id="ai-analysis-content">
                        <!-- ìœ í†µëŸ‰ -->
                        <div class="glass-card p-3">
                            <div class="text-gray-400 text-xs mb-1">ğŸ“Š ìœ í†µëŸ‰</div>
                            <div class="font-bold" id="ai-circulation">-</div>
                            <div class="text-xs text-gray-400" id="ai-supply">-</div>
                        </div>
                        <!-- ì£¼í¬ í¬ì§„ -->
                        <div class="glass-card p-3">
                            <div class="text-gray-400 text-xs mb-1">ğŸ‹ ì£¼í¬ í¬ì§„</div>
                            <div class="font-bold text-emerald-400" id="ai-whale">-</div>
                            <div class="text-xs text-gray-400" id="ai-whale-detail">-</div>
                        </div>
                        <!-- í”„ë ‰íƒˆ í•¸ë“¤ë§ -->
                        <div class="glass-card p-3">
                            <div class="text-gray-400 text-xs mb-1">ğŸ“ í”„ë ‰íƒˆ í•¸ë“¤ë§</div>
                            <div class="font-bold text-cyan-400" id="ai-fractal">-</div>
                            <div class="text-xs text-gray-400" id="ai-fractal-detail">-</div>
                        </div>
                        <!-- ê±°ë˜ ì¶”ì²œ -->
                        <div class="glass-card p-3">
                            <div class="text-gray-400 text-xs mb-1">ğŸ¯ ê±°ë˜ ì¶”ì²œ</div>
                            <div class="grid grid-cols-3 gap-1 text-xs">
                                <div><span class="text-gray-400">ì§„ì…</span><br><span class="font-bold"
                                        id="ai-entry">-</span></div>
                                <div><span class="text-gray-400">ì†ì ˆ</span><br><span class="text-red-400 font-bold"
                                        id="ai-sl">-</span></div>
                                <div><span class="text-gray-400">ìµì ˆ</span><br><span class="text-emerald-400 font-bold"
                                        id="ai-tp">-</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ğŸ“Š ì‹œì¥ í†µê³„ íŒ¨ë„ (TradingView ìŠ¤íƒ€ì¼) - ìƒˆë¡œ ì¶”ê°€ -->
                <div class="glass-card p-3 mt-3" id="market-stats-panel">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="text-lg">ğŸ“ˆ</span>
                        <h3 class="font-bold">ì£¼ìš” í†µê³„</h3>
                        <span class="text-xs text-gray-400" id="stats-coin-name">BTC</span>
                        <span class="text-xs text-emerald-400 ml-auto">â— ë§ˆì¼“ ì˜¤í”ˆ</span>
                    </div>

                    <!-- ê±°ë˜ëŸ‰ í†µê³„ -->
                    <div class="grid grid-cols-2 gap-3 text-sm mb-4">
                        <div class="flex justify-between">
                            <span class="text-gray-400">ê±°ë˜ëŸ‰</span>
                            <span class="text-white font-bold" id="stats-volume">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">í‰ê·  ë³¼ë¥¨(30)</span>
                            <span class="text-white font-bold" id="stats-avg-volume">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">ì‹œê°€ì´ì•¡</span>
                            <span class="text-white font-bold" id="stats-market-cap">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">ì¶œì²˜</span>
                            <span class="text-purple-400 text-xs" id="stats-source">CoinGecko</span>
                        </div>
                    </div>

                    <!-- ì„±ê³¼ íƒ€ì¼ -->
                    <div class="mb-2">
                        <div class="text-gray-400 text-xs mb-2">ì„±ê³¼</div>
                        <div class="grid grid-cols-3 gap-2">
                            <div class="glass-card p-2 text-center" id="perf-1w">
                                <div class="text-lg font-bold text-gray-400">-</div>
                                <div class="text-xs text-gray-500">1W</div>
                            </div>
                            <div class="glass-card p-2 text-center" id="perf-1m">
                                <div class="text-lg font-bold text-gray-400">-</div>
                                <div class="text-xs text-gray-500">1M</div>
                            </div>
                            <div class="glass-card p-2 text-center" id="perf-3m">
                                <div class="text-lg font-bold text-gray-400">-</div>
                                <div class="text-xs text-gray-500">3M</div>
                            </div>
                            <div class="glass-card p-2 text-center" id="perf-6m">
                                <div class="text-lg font-bold text-gray-400">-</div>
                                <div class="text-xs text-gray-500">6M</div>
                            </div>
                            <div class="glass-card p-2 text-center" id="perf-ytd">
                                <div class="text-lg font-bold text-gray-400">-</div>
                                <div class="text-xs text-gray-500">YTD</div>
                            </div>
                            <div class="glass-card p-2 text-center" id="perf-1y">
                                <div class="text-lg font-bold text-gray-400">-</div>
                                <div class="text-xs text-gray-500">1Y</div>
                            </div>
                        </div>
                    </div>

                    <!-- ë°ì´í„° ê°±ì‹  ì‹œê°„ -->
                    <div class="text-right text-xs text-gray-500 mt-2" id="stats-timestamp">
                        ë§ˆì§€ë§‰ ê°±ì‹ : -
                    </div>
                </div>

                <!-- Final Top 5 Tables -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 mt-3">

                    <!-- ë©”ì´ì € ì½”ì¸ Top 5 -->
                    <div class="glass-card p-3">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">ğŸ†</span>
                                <h3 class="font-bold">Final Top 5 - ë©”ì´ì € ì½”ì¸</h3>
                            </div>
                            <span class="text-xs text-gray-400" id="major-sort-criteria">ìƒìŠ¹ëŸ‰ â†’ ê±°ë˜ëŸ‰ â†’ NICE</span>
                        </div>
                        <div class="space-y-2" id="major-coins-list">
                            <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                            <div class="text-center text-gray-500 py-4">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                        </div>
                    </div>

                    <!-- ê¸°íƒ€ ì½”ì¸ Top 5 -->
                    <div class="glass-card p-3">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">â­</span>
                                <h3 class="font-bold">Final Top 5 - ê¸°íƒ€ ì½”ì¸</h3>
                            </div>
                            <span class="text-xs text-gray-400">ê³ ìˆ˜ìµ Â· ê³ ë³€ë™</span>
                        </div>
                        <div class="space-y-2" id="other-coins-list">
                            <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                            <div class="text-center text-gray-500 py-4">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI ë¦¬í¬íŠ¸ íƒ­ (ê³ ì • ë ˆì´ì•„ì›ƒ) -->
            <div id="tab-report" class="tab-content"
                style="height: calc(100vh - 180px); display: flex; flex-direction: column; overflow-y: auto;">
                <!-- ìƒë‹¨ ìš”ì•½ ì¹´ë“œ (NICE ê²Œì´ì§€ + ìœ„í—˜ ê´€ë¦¬) -->
                <div class="glass-card p-4 mb-3" style="flex-shrink: 0;">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-lg text-emerald-400" id="ai-report-signal">ğŸŸ¢ TYPE A ì‹ í˜¸ í¬ì°©!</h3>
                        <button id="refresh-ai-report" onclick="refreshAIReport()"
                            class="px-3 py-1 bg-purple-600 hover:bg-purple-500 rounded-lg text-white text-sm flex items-center gap-1 transition-all">
                            ğŸ”„ ìƒˆë¡œê³ ì¹¨
                        </button>
                    </div>

                    <!-- NICE ê²Œì´ì§€ + í†µê³„ ê·¸ë¦¬ë“œ -->
                    <div class="flex items-center gap-6">
                        <!-- SVG NICE ê²Œì´ì§€ -->
                        <div class="nice-gauge-container">
                            <svg class="nice-gauge" viewBox="0 0 100 100">
                                <circle class="gauge-bg" cx="50" cy="50" r="45" />
                                <circle class="gauge-fill type-a" id="nice-gauge-fill" cx="50" cy="50" r="45"
                                    stroke-dasharray="283" stroke-dashoffset="40" />
                            </svg>
                            <div class="nice-gauge-value text-emerald-400" id="nice-gauge-value">86</div>
                            <div class="nice-gauge-label">NICE SCORE</div>
                        </div>

                        <!-- í†µê³„ ê·¸ë¦¬ë“œ -->
                        <div class="flex-1 grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-gray-400 text-xs mb-1">ì‹ ë¢°ë„ (Palantir)</div>
                                <div class="font-bold text-lg" id="report-reliability">85%</div>
                            </div>
                            <div>
                                <div class="text-gray-400 text-xs mb-1">ì‹œì¥ ìƒíƒœ</div>
                                <div class="font-bold text-lg" id="report-market-state">BULL</div>
                            </div>

                            <!-- ìœ„í—˜ ê´€ë¦¬ í”„ë¡œê·¸ë ˆìŠ¤ ë°” -->
                            <div class="col-span-2">
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-gray-400">Kelly ë°°íŒ… ë¹„ìœ¨</span>
                                    <span class="font-bold" id="report-kelly">4.0%</span>
                                </div>
                                <div class="risk-progress">
                                    <div class="risk-progress-fill risk-low" id="kelly-progress" style="width: 40%;">
                                    </div>
                                </div>
                                <div class="text-xs text-gray-500 mt-1" id="kelly-status">ë‚®ì€ ìœ„í—˜ - ì•ˆì „í•œ ì§„ì… ê°€ëŠ¥</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì¤‘ê°„ ì˜ì—­: ì°¨íŠ¸ (40%) + ì „ë¬¸ê°€ (60%) -->
                <div class="flex-1 grid grid-cols-5 gap-2 min-h-0">
                    <!-- ë ˆì´ì–´ ì°¨íŠ¸ (40%) -->
                    <div class="col-span-2 glass-card p-3 flex flex-col">
                        <h3 class="font-bold text-sm mb-2">ğŸ“Š ë ˆì´ì–´ë³„ ë¶„ì„</h3>
                        <div class="flex-1 min-h-0">
                            <canvas id="layerChart" style="width: 100%; height: 100%;"></canvas>
                        </div>
                    </div>

                    <!-- ì „ë¬¸ê°€ ê´€ì  (60%) - ìŠ¤í¬ë¡¤ ê°€ëŠ¥ -->
                    <div class="col-span-3 glass-card p-3 flex flex-col">
                        <h3 class="font-bold text-sm mb-2">ğŸ’¼ ì „ë¬¸ê°€ ê´€ì </h3>
                        <div id="expert-views" class="flex-1 overflow-y-auto space-y-2 text-sm pr-1"
                            style="max-height: 100%;">
                            ë¡œë”© ì¤‘...
                        </div>
                    </div>
                </div>

                <!-- ë°±í…ŒìŠ¤íŠ¸ ìš”ì•½ ì„¹ì…˜ -->
                <div class="backtest-summary mt-3" style="flex-shrink: 0;">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-sm">ğŸ“Š ê³¼ê±° ì„±ê³¼ (ë°±í…ŒìŠ¤íŠ¸)</h3>
                        <span class="text-xs text-gray-500">2024.01 - 2025.01</span>
                    </div>
                    <div class="grid grid-cols-4 gap-4">
                        <div class="backtest-stat flex-col items-center text-center">
                            <div class="backtest-stat-label">ìŠ¹ë¥ </div>
                            <div class="backtest-stat-value backtest-positive text-xl" id="backtest-winrate">68.5%</div>
                        </div>
                        <div class="backtest-stat flex-col items-center text-center">
                            <div class="backtest-stat-label">ì´ ìˆ˜ìµë¥ </div>
                            <div class="backtest-stat-value backtest-positive text-xl" id="backtest-profit">+142.3%
                            </div>
                        </div>
                        <div class="backtest-stat flex-col items-center text-center">
                            <div class="backtest-stat-label">ìµœëŒ€ ë‚™í­</div>
                            <div class="backtest-stat-value backtest-negative text-xl" id="backtest-drawdown">-18.2%
                            </div>
                        </div>
                        <div class="backtest-stat flex-col items-center text-center">
                            <div class="backtest-stat-label">ìƒ¤í”„ ë¹„ìœ¨</div>
                            <div class="backtest-stat-value text-purple-400 text-xl" id="backtest-sharpe">1.85</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì´ˆ ê¸‰ë“± íƒ­ -->
            <div id="tab-surge" class="tab-content" style="height: calc(100vh - 180px); overflow-y: auto;">
                <div class="space-y-4 pb-4">
                    <!-- ì„¸ì…˜ í‘œì‹œê¸° -->
                    <div class="glass-card p-4 rounded-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="font-bold text-lg" id="surge-session-name">ğŸŒ í˜„ì¬ ì„¸ì…˜ ë¡œë”©...</h3>
                                <p class="text-gray-400 text-sm" id="surge-session-details">ìœ ë™ì„±: - | ë³€ë™ì„±: -</p>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-400">ë‹¤ìŒ ì„¸ì…˜ê¹Œì§€</div>
                                <div class="font-bold text-xl text-purple-400" id="surge-countdown">--:--</div>
                                <div class="text-xs text-gray-500" id="surge-next-session">-</div>
                            </div>
                        </div>
                        <!-- ì„¸ì…˜ íƒ€ì„ë¼ì¸ -->
                        <div class="mt-3 flex gap-1 overflow-x-auto">
                            <div class="px-2 py-1 bg-gray-800 rounded text-xs">ğŸŒ… 06:30</div>
                            <div class="px-2 py-1 bg-gray-800 rounded text-xs">ğŸŒ 09:00</div>
                            <div class="px-2 py-1 bg-gray-800 rounded text-xs">â˜€ï¸ 12:00</div>
                            <div class="px-2 py-1 bg-gray-800 rounded text-xs">ğŸŒ 14:00</div>
                            <div class="px-2 py-1 bg-purple-600 rounded text-xs font-bold">ğŸŒ† 16:30</div>
                            <div class="px-2 py-1 bg-gray-800 rounded text-xs">ğŸŒ‡ 19:30</div>
                            <div class="px-2 py-1 bg-gray-800 rounded text-xs">ğŸŒ 21:30</div>
                            <div class="px-2 py-1 bg-gray-800 rounded text-xs">ğŸŒ 24:00</div>
                        </div>
                    </div>

                    <!-- ê¸‰ë“± ì½”ì¸ ë¦¬ìŠ¤íŠ¸ -->
                    <div class="glass-card p-4 rounded-xl">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-bold">ğŸš€ ê¸‰ë“± ì½”ì¸ TOP 10</h3>
                            <button onclick="loadSuperSurge()"
                                class="px-3 py-1 bg-purple-600 hover:bg-purple-500 rounded-lg text-sm">
                                ğŸ”„ ìƒˆë¡œê³ ì¹¨
                            </button>
                        </div>
                        <div id="surge-coins-list" class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <div class="text-gray-400 text-center py-8">ë¡œë”© ì¤‘...</div>
                        </div>
                        <div class="mt-3 text-sm text-gray-500 flex justify-between">
                            <span id="surge-analyzed-count">ë¶„ì„ëœ ì½”ì¸: -</span>
                            <span id="surge-reliability">Palantir ì‹ ë¢°ë„: -</span>
                        </div>
                    </div>

                    <!-- AI ì¸ì‚¬ì´íŠ¸ (Perplexity) -->
                    <div class="glass-card p-4 rounded-xl">
                        <h3 class="font-bold mb-3">ğŸ¤– AI ì¸ì‚¬ì´íŠ¸ (Perplexity)</h3>
                        <div id="surge-ai-insights" class="text-sm text-gray-300 space-y-2">
                            <div class="text-gray-400">AI ë¶„ì„ì„ ë¡œë”©í•˜ë ¤ë©´ ìƒˆë¡œê³ ì¹¨ì„ í´ë¦­í•˜ì„¸ìš”.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì‹œì¥ ë¶„ì„ íƒ­ -->
            <div id="tab-analysis" class="tab-content" style="height: calc(100vh - 180px); overflow-y: auto;">
                <div class="space-y-6 pb-6">
                    <!-- Market Gate Section -->
                    <section id="market-gate-section"></section>

                    <!-- Lead-Lag Section -->
                    <section id="lead-lag-section"></section>
                </div>
            </div>

        </main>

        <!-- ì½”ì¸ ìƒì„¸ ë¶„ì„ ëª¨ë‹¬ -->
        <div class="modal-overlay" id="coin-modal">
            <div class="modal-content" style="max-width: 900px;">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <h2 class="text-xl font-bold" id="modal-title">BTC Bitcoin</h2>
                        <span id="modal-type-badge" class="type-badge type-a">Type A</span>
                        <span id="modal-price" class="text-emerald-400 font-bold">$98,000</span>
                        <span id="modal-change" class="text-emerald-400">+2.5%</span>
                    </div>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>

                <!-- ë¯¸ë‹ˆ ì°¨íŠ¸ -->
                <div class="glass-card p-3 mb-4" style="height: 200px;">
                    <div id="modal-chart-container" style="width: 100%; height: 100%;"></div>
                </div>

                <!-- AI íˆ¬ì ë¶„ì„ -->
                <div class="glass-card p-3 mb-4">
                    <h3 class="font-bold text-emerald-400 mb-3">ğŸ¤– AI íˆ¬ì ë¶„ì„</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                        <div class="glass-card p-2">
                            <div class="text-gray-400 text-xs">ğŸ“Š ìœ í†µëŸ‰</div>
                            <div class="font-bold" id="modal-circulation">93.2%</div>
                            <div class="text-xs text-gray-400" id="modal-supply">19.8M / 21M</div>
                        </div>
                        <div class="glass-card p-2">
                            <div class="text-gray-400 text-xs">ğŸ‹ ì£¼í¬ í¬ì§„</div>
                            <div class="font-bold text-cyan-400" id="modal-whale">ì¶•ì  ì¤‘</div>
                            <div class="text-xs text-gray-400" id="modal-whale-detail">152 ì§€ê°‘, 38.5%</div>
                        </div>
                        <div class="glass-card p-2">
                            <div class="text-gray-400 text-xs">ğŸ“ í”„ë ‰íƒˆ í•¸ë“¤ë§</div>
                            <div class="font-bold text-purple-400" id="modal-fractal">Higher High</div>
                            <div class="text-xs text-gray-400" id="modal-fractal-detail">ê°•ë„ 82%</div>
                        </div>
                        <div class="glass-card p-2">
                            <div class="text-gray-400 text-xs">ğŸ¯ NICE ì ìˆ˜</div>
                            <div class="font-bold text-emerald-400" id="modal-nice-score">86</div>
                            <div class="text-xs text-gray-400" id="modal-nice-type">Type A ì‹ í˜¸</div>
                        </div>
                    </div>
                </div>

                <!-- ê±°ë˜ ì¶”ì²œ -->
                <div class="glass-card p-3 mb-4" style="background: rgba(16, 185, 129, 0.1); border-color: #10b981;">
                    <h3 class="font-bold text-emerald-400 mb-3">ğŸ¯ ê±°ë˜ ì¶”ì²œ (í˜„ì¬ ì‹œê°„ ê¸°ì¤€)</h3>
                    <div class="grid grid-cols-3 md:grid-cols-6 gap-3 text-center text-sm">
                        <div>
                            <div class="text-gray-400 text-xs">ì§„ì…ê°€</div>
                            <div class="font-bold text-cyan-400" id="modal-entry">$97,500</div>
                        </div>
                        <div>
                            <div class="text-gray-400 text-xs">ì†ì ˆê°€ (SL)</div>
                            <div class="font-bold text-red-400" id="modal-sl">$95,550</div>
                        </div>
                        <div>
                            <div class="text-gray-400 text-xs">ìµì ˆê°€ (TP)</div>
                            <div class="font-bold text-emerald-400" id="modal-tp">$101,920</div>
                        </div>
                        <div>
                            <div class="text-gray-400 text-xs">ì†ìµë¹„ (R:R)</div>
                            <div class="font-bold text-yellow-400" id="modal-rr">1:2.2</div>
                        </div>
                        <div>
                            <div class="text-gray-400 text-xs">Kelly %</div>
                            <div class="font-bold" id="modal-kelly">4.0%</div>
                        </div>
                        <div>
                            <div class="text-gray-400 text-xs">Time-Stop</div>
                            <div class="font-bold" id="modal-timestop">30ë¶„</div>
                        </div>
                    </div>
                </div>

                <!-- ë§¤ìˆ˜/ë§¤ë„ ë²„íŠ¼ -->
                <div class="grid grid-cols-2 gap-4">
                    <button id="modal-buy-btn" class="py-3 rounded-lg font-bold text-lg transition-all hover:scale-105"
                        style="background: linear-gradient(135deg, #10b981, #059669);">
                        ğŸ“ˆ ë§¤ìˆ˜ ì¶”ì²œ
                    </button>
                    <button id="modal-sell-btn"
                        class="py-3 rounded-lg font-bold text-lg transition-all hover:scale-105 opacity-50"
                        style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                        ğŸ“‰ ë§¤ë„ (ë³´ë¥˜)
                    </button>
                </div>

                <!-- ì‹œê°„ ì •ë³´ -->
                <div class="text-center text-xs text-gray-400 mt-3">
                    ë¶„ì„ ì‹œê°: <span id="modal-time">19:45:00</span> | ìœ íš¨ ì‹œê°„: 30ë¶„ | ë‹¤ìŒ ê°±ì‹ : <span
                        id="modal-next-update">20:00</span>
                </div>
            </div>
        </div>

        <footer class="text-center py-3 text-gray-500 text-xs">
            NICE v4 PRO | ë¸”ë™ë¡ Ã— JPëª¨ê±´ Ã— ì „ë¬¸ íŠ¸ë ˆì´ë” í†µí•© ë¶„ì„ | ë¹—ì¸ 448ê°œ ì½”ì¸ ë¶„ì„
        </footer>
    </div>

    <!-- TradingView ìœ„ì ¯ ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <script>
        // ========== NEW: API Caching Layer ==========
        const apiCache = new Map();
        const CACHE_TTL = 30000; // 30 seconds

        async function cachedFetch(url, options = {}) {
            const now = Date.now();
            const cacheKey = url + JSON.stringify(options);
            const cached = apiCache.get(cacheKey);

            if (cached && now - cached.timestamp < CACHE_TTL) {
                return cached.data;
            }

            try {
                const res = await fetch(url, options);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                apiCache.set(cacheKey, { data, timestamp: now });
                return data;
            } catch (err) {
                // Return cached data if available, even if stale
                if (cached) {
                    console.warn(`Using stale cache for ${url}:`, err.message);
                    return cached.data;
                }
                throw err;
            }
        }

        // ========== NEW: Toast Notification System ==========
        function showToast(message, type = 'info', duration = 3000) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ•' : 'â„¹'}</span>
                <span class="ml-2">${message}</span>
            `;
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // ========== NEW: Data Field Update Utility ==========
        function setDataField(id, value, options = {}) {
            const el = document.getElementById(id);
            if (!el) return;

            const {
                fallback = 'ë¶„ì„ ì¤‘...',
                prefix = '',
                suffix = '',
                colorByValue = false
            } = options;

            // Remove skeleton state
            el.classList.remove('skeleton', 'skeleton-text');

            if (value !== null && value !== undefined && value !== '') {
                el.textContent = prefix + value + suffix;
                el.classList.remove('text-gray-500');

                // Apply color based on value (for percentages)
                if (colorByValue && typeof value === 'number') {
                    el.classList.remove('text-emerald-400', 'text-red-400', 'text-gray-400');
                    if (value > 0) el.classList.add('text-emerald-400');
                    else if (value < 0) el.classList.add('text-red-400');
                    else el.classList.add('text-gray-400');
                }
            } else {
                el.textContent = fallback;
                el.classList.add('text-gray-500');
            }
        }

        // ========== NEW: Set Skeleton Loading State ==========
        function setLoadingState(ids) {
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.add('skeleton', 'skeleton-text');
                    el.textContent = 'Loading...';
                }
            });
        }

        // ========== NEW: Format Helpers ==========
        function formatPrice(value, options = {}) {
            if (!value || isNaN(value)) return '-';
            const { currency = '$', decimals = 2 } = options;

            if (value >= 1000) {
                return currency + value.toLocaleString(undefined, { maximumFractionDigits: 0 });
            } else if (value >= 1) {
                return currency + value.toLocaleString(undefined, { maximumFractionDigits: decimals });
            } else {
                return currency + value.toLocaleString(undefined, { maximumFractionDigits: 6 });
            }
        }

        function formatLargeNumber(value) {
            if (!value || isNaN(value)) return '-';
            if (value >= 1e12) return `${(value / 1e12).toFixed(2)}T`;
            if (value >= 1e9) return `${(value / 1e9).toFixed(2)}B`;
            if (value >= 1e6) return `${(value / 1e6).toFixed(1)}M`;
            return value.toLocaleString();
        }

        // ========== ORIGINAL VARIABLES ==========
        let selectedCoin = 'BTC';
        let tvWidget = null;

        // ì‹œì¥ ì§€ë„ ë°ì´í„° (APIì—ì„œ ë¡œë“œë¨ - í•˜ë“œì½”ë”© ì œê±°)
        let marketMapData = [];  // loadRankings()ì—ì„œ ì±„ì›Œì§

        // TradingView ìœ„ì ¯ ì´ˆê¸°í™” (Elliott Wave, Fibonacci, ì¶”ì„¸ì„  í¬í•¨)
        function initTradingView(symbol = 'BTC', interval = '5') {
            const container = document.getElementById('tv-widget-container');
            container.innerHTML = '';

            // TradingView Interval ë§¤í•‘
            const intervalMap = {
                'scalp': '5',
                'short': '15',
                'medium': '60',
                'long': '240'  // 4ì‹œê°„
            };

            // ë§Œì•½ interval íŒŒë¼ë¯¸í„°ê°€ timeframe ë¬¸ìì—´ì´ë©´ ë§¤í•‘ëœ ê°’ ì‚¬ìš©
            const tvInterval = intervalMap[interval] || interval;

            new TradingView.widget({
                "autosize": true,
                "symbol": `BITHUMB:${symbol}KRW`,
                "interval": tvInterval,
                "timezone": "Asia/Seoul",
                "theme": "dark",
                "style": "1",
                "locale": "kr",
                "toolbar_bg": "#1a1a2e",
                "enable_publishing": false,
                "hide_top_toolbar": false,
                "hide_legend": false,
                "save_image": false,
                "container_id": "tv-widget-container",
                "withdateranges": true,
                "allow_symbol_change": true,
                "details": true,
                "hotlist": true,
                "calendar": false,
                "studies": [
                    // ê¸°ë³¸ ì§€í‘œ
                    "BB@tv-basicstudies",               // ë³¼ë¦°ì € ë°´ë“œ
                    "RSI@tv-basicstudies",              // RSI
                    "MACD@tv-basicstudies",             // MACD
                    "Volume@tv-basicstudies",           // ê±°ë˜ëŸ‰
                    "StochasticRSI@tv-basicstudies",    // ìŠ¤í† ìºìŠ¤í‹± RSI

                    // ì´ë™í‰ê· ì„  (EMA)
                    "MAExp@tv-basicstudies",            // EMA 20
                    "MAExp@tv-basicstudies",            // EMA 50
                    "MAExp@tv-basicstudies",            // EMA 200

                    // ì¶”ê°€ ê¸°ìˆ ì  ì§€í‘œ - Elliott Wave, Fibonacci, Trendline
                    "PSAR@tv-basicstudies",             // Parabolic SAR (ì¶”ì„¸)
                    "PivotPointsStandard@tv-basicstudies", // í”¼ë´‡ í¬ì¸íŠ¸ (ì§€ì§€/ì €í•­)
                    "ZigZag@tv-basicstudies",           // ì§€ê·¸ì¬ê·¸ (íŒŒë™ íŒ¨í„´)
                    "IchimokuCloud@tv-basicstudies",    // ì¼ëª©ê· í˜•í‘œ (êµ¬ë¦„)
                    "ADX@tv-basicstudies"               // ADX (ì¶”ì„¸ ê°•ë„)
                ],
                "studies_overrides": {
                    "volume.volume.color.0": "#ef4444",
                    "volume.volume.color.1": "#10b981",
                    // EMA ì„¤ì •
                    "moving average exponential.length": 20,
                    // ZigZag ì„¤ì • (íŒŒë™ ë¶„ì„ìš©)
                    "zigzag.deviation": 5
                }
            });

            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.indicator-btn[data-tf]').forEach(btn => btn.classList.remove('active'));
            // ê°€ì¥ ê·¼ì ‘í•œ ë²„íŠ¼ ì°¾ê¸° (ë‹¨ìˆœí™”)
            const btn = document.querySelector(`.indicator-btn[data-tf="${tvInterval}"]`) ||
                document.querySelector(`.indicator-btn[data-tf="5"]`);
            if (btn) btn.classList.add('active');
        }

        let currentChartInstance = null; // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì „ì—­ ê´€ë¦¬

        // AI ë¦¬í¬íŠ¸ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í•¸ë“¤ëŸ¬
        async function refreshAIReport() {
            const btn = document.getElementById('refresh-ai-report');
            if (btn) {
                btn.innerHTML = 'â³ ë¡œë”©...';
                btn.disabled = true;
            }

            try {
                await loadAIReport();
                await loadExpertAnalysis();

                // ê°±ì‹  ì‹œê°„ ì—…ë°ì´íŠ¸
                const now = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                if (btn) btn.innerHTML = `âœ… ${now}`;

                setTimeout(() => {
                    if (btn) btn.innerHTML = 'ğŸ”„ ìƒˆë¡œê³ ì¹¨';
                    btn.disabled = false;
                }, 2000);
            } catch (e) {
                console.error('AI Report refresh error:', e);
                if (btn) {
                    btn.innerHTML = 'âŒ ì‹¤íŒ¨';
                    setTimeout(() => {
                        btn.innerHTML = 'ğŸ”„ ìƒˆë¡œê³ ì¹¨';
                        btn.disabled = false;
                    }, 2000);
                }
            }
        }

        // AI ë¦¬í¬íŠ¸ ë°ì´í„° ë¡œë“œ (ë ˆì´ì–´ ì°¨íŠ¸ + ìš”ì•½)
        async function loadAIReport() {
            const ctx = document.getElementById('layerChart');
            if (!ctx) return;

            try {
                // ì‹œì¥ ë¶„ì„ API í˜¸ì¶œ
                const res = await fetch('/api/nice/market');
                const data = await res.json();

                if (data.error) {
                    console.error('AI Report error:', data.error);
                    return;
                }

                // ë ˆì´ì–´ ì ìˆ˜ ì¶”ì¶œ
                const layers = data.layers || {};
                const scores = [
                    layers.technical?.score || 0,
                    layers.onchain?.score || 0,
                    layers.sentiment?.score || 0,
                    layers.macro?.score || 0,
                    layers.etf?.score || 0
                ];

                // ì´ì  ë° ì‹ í˜¸ íƒ€ì… ì—…ë°ì´íŠ¸
                const totalScore = data.total_score || 0;
                const signalType = data.signal_type || 'B';
                const typeClass = signalType === 'A' ? 'text-emerald-400' : (signalType === 'B' ? 'text-yellow-400' : 'text-red-400');
                const typeEmoji = signalType === 'A' ? 'ğŸŸ¢' : (signalType === 'B' ? 'ğŸŸ¡' : 'ğŸ”´');

                // AI ë¦¬í¬íŠ¸ í—¤ë” ì—…ë°ì´íŠ¸
                const signalHeader = document.getElementById('ai-report-signal');
                if (signalHeader) {
                    signalHeader.innerHTML = `${typeEmoji} TYPE ${signalType} ${data.recommendation || 'ì‹ í˜¸'}`;
                    signalHeader.className = `font-bold text-lg ${typeClass}`;
                }

                // NICE ê²Œì´ì§€ ì—…ë°ì´íŠ¸ (SVG)
                const gaugeValue = document.getElementById('nice-gauge-value');
                const gaugeFill = document.getElementById('nice-gauge-fill');
                if (gaugeValue && gaugeFill) {
                    gaugeValue.textContent = totalScore.toFixed(0);
                    gaugeValue.className = `nice-gauge-value ${typeClass}`;

                    // ì›í˜• ê²Œì´ì§€ ê³„ì‚° (283 = 2 * PI * 45)
                    const circumference = 283;
                    const offset = circumference - (totalScore / 100 * circumference);
                    gaugeFill.setAttribute('stroke-dashoffset', offset);
                    gaugeFill.className.baseVal = `gauge-fill type-${signalType.toLowerCase()}`;
                }

                // Palantir ì‹ ë¢°ë„ ì—…ë°ì´íŠ¸
                const reliabilityEl = document.getElementById('report-reliability');
                if (reliabilityEl) {
                    reliabilityEl.textContent = `${data.signal_confidence || 85}%`;
                }

                // ì‹œì¥ ìƒíƒœ ì—…ë°ì´íŠ¸
                const marketStateEl = document.getElementById('report-market-state');
                if (marketStateEl) {
                    marketStateEl.textContent = data.market_state || 'NEUTRAL';
                }

                // Kelly í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸
                const kellyPct = signalType === 'A' ? 4.0 : (signalType === 'B' ? 2.0 : 0);
                const kellyEl = document.getElementById('report-kelly');
                const kellyProgress = document.getElementById('kelly-progress');
                const kellyStatus = document.getElementById('kelly-status');

                if (kellyEl) kellyEl.textContent = `${kellyPct}%`;
                if (kellyProgress) {
                    const progressWidth = Math.min(100, kellyPct * 10); // 10% Kelly = 100%
                    kellyProgress.style.width = `${progressWidth}%`;

                    // ìœ„í—˜ ìˆ˜ì¤€ë³„ ìƒ‰ìƒ
                    kellyProgress.className = `risk-progress-fill ${kellyPct <= 4 ? 'risk-low' : (kellyPct <= 8 ? 'risk-medium' : 'risk-high')
                        }`;
                }
                if (kellyStatus) {
                    kellyStatus.textContent = kellyPct <= 4 ? 'ë‚®ì€ ìœ„í—˜ - ì•ˆì „í•œ ì§„ì… ê°€ëŠ¥' :
                        (kellyPct <= 8 ? 'ì¤‘ê°„ ìœ„í—˜ - ì£¼ì˜ í•„ìš”' : 'ë†’ì€ ìœ„í—˜ âš ï¸ - í¬ì§€ì…˜ ì¶•ì†Œ ê¶Œì¥');
                }

                // ì°¨íŠ¸ ìƒ‰ìƒ ê²°ì • (ì ìˆ˜ ê¸°ë°˜)
                const colors = scores.map(s => {
                    if (s >= 25) return '#10b981';     // ë…¹ìƒ‰ (ì¢‹ìŒ)
                    else if (s >= 15) return '#f59e0b'; // í™©ìƒ‰ (ì¤‘ë¦½)
                    else return '#ef4444';             // ì ìƒ‰ (ë‚˜ì¨)
                });

                // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´
                if (currentChartInstance) {
                    currentChartInstance.destroy();
                    currentChartInstance = null;
                }

                // ìƒˆ ì°¨íŠ¸ ìƒì„±
                currentChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['ê¸°ìˆ ë¶„ì„', 'OnChain', 'ì‹œì¥ì‹¬ë¦¬', 'ë§¤í¬ë¡œ', 'ETF/ê¸°ê´€'],
                        datasets: [{
                            label: 'ë ˆì´ì–´ ì ìˆ˜ (/30)',
                            data: scores,
                            backgroundColor: colors,
                            borderRadius: 4,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `${ctx.parsed.y}/30ì `
                                }
                            }
                        },
                        scales: {
                            y: { beginAtZero: true, max: 30, ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                            x: { ticks: { color: '#9ca3af' }, grid: { display: false } }
                        }
                    }
                });

            } catch (e) {
                console.error('AI Report load error:', e);
                // í´ë°±: ê¸°ë³¸ ì°¨íŠ¸
                initFallbackLayerChart();
            }
        }

        // í´ë°± ë ˆì´ì–´ ì°¨íŠ¸ (API ì‹¤íŒ¨ ì‹œ)
        function initFallbackLayerChart() {
            const ctx = document.getElementById('layerChart');
            if (!ctx) return;

            if (currentChartInstance) {
                currentChartInstance.destroy();
            }

            currentChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ê¸°ìˆ ë¶„ì„', 'OnChain', 'ì‹œì¥ì‹¬ë¦¬', 'ë§¤í¬ë¡œ', 'ETF/ê¸°ê´€'],
                    datasets: [{
                        label: 'ë¶„ì„ ì ìˆ˜',
                        data: [20, 15, 18, 12, 22],
                        backgroundColor: ['#10b981', '#00d4ff', '#f59e0b', '#ef4444', '#10b981'],
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 30, ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: '#9ca3af' }, grid: { display: false } }
                    }
                }
            });
        }

        // ê¸°ì¡´ initLayerChartë¥¼ loadAIReportë¡œ ëŒ€ì²´
        function initLayerChart() {
            loadAIReport();
        }

        // Market Map ë Œë”ë§
        function renderMarketMap() {
            const container = document.getElementById('market-map');
            if (!container) return;

            if (!marketMapData || marketMapData.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 col-span-4 py-10">ë°ì´í„° ë¡œë”© ì¤‘...</div>';
                return;
            }

            container.innerHTML = marketMapData.map(coin => {
                const colorClass = coin.change >= 3 ? 'bullish' : (coin.change <= -3 ? 'bearish' : 'neutral');
                const sizeClass = coin.size >= 3 ? 'col-span-2 row-span-2' : (coin.size >= 2 ? 'col-span-1 row-span-2' : '');
                const baselineLabel = coin.isMidnight ? 'â°' : '';  // 00:00 ê¸°ì¤€ í‘œì‹œ

                return `
                    <div class="market-map-cell ${colorClass} ${sizeClass}" 
                         onclick="selectCoin('${coin.symbol}')"
                         title="${coin.name}: ${coin.change >= 0 ? '+' : ''}${coin.change.toFixed(1)}% ${coin.isMidnight ? '(00:00 ê¸°ì¤€)' : '(24h)'}">
                        <div class="font-bold text-xs">${coin.symbol} ${baselineLabel}</div>
                        <div class="text-xs opacity-80">${coin.change >= 0 ? '+' : ''}${coin.change.toFixed(1)}%</div>
                    </div>
                `;
            }).join('');
        }

        let currentTimeframe = 'scalp'; // í˜„ì¬ íƒ€ì„í”„ë ˆì„ ìƒíƒœ

        // ì½”ì¸ ì¹´ë“œ ë Œë”ë§
        function renderCoinCard(coin, idx, isMajor) {
            const typeClass = coin.nice?.type === 'A' ? 'type-a' : (coin.nice?.type === 'B' ? 'type-b' : 'type-c');
            const scoreColor = coin.nice?.score >= 75 ? 'text-emerald-400' : (coin.nice?.score >= 55 ? 'text-yellow-400' : 'text-red-400');
            const changeColor = coin.change_24h >= 0 ? 'text-emerald-400' : 'text-red-400';
            const badgeClass = isMajor ? 'badge-major' : 'badge-other';
            const volumeFormatted = formatVolume(coin.volume_24h);

            return `
                <div class="coin-card ${coin.symbol === selectedCoin ? 'selected' : ''}" 
                     data-symbol="${coin.symbol}"
                     onclick="selectCoin('${coin.symbol}')">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-lg">#${idx + 1}</span>
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="font-bold">${coin.symbol}</span>
                                    <span class="text-xs ${badgeClass} px-1 rounded">${isMajor ? 'ë©”ì´ì €' : 'ê¸°íƒ€'}</span>
                                </div>
                                <div class="text-xs text-gray-400">${coin.sector || ''}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="${changeColor} font-bold">${coin.change_24h >= 0 ? '+' : ''}${coin.change_24h?.toFixed(1)}%</div>
                            <div class="text-xs text-gray-400">Vol: ${volumeFormatted}</div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-2 text-xs">
                        <span class="type-badge ${typeClass}">Type ${coin.nice?.type}</span>
                        <span class="${scoreColor} font-bold">NICE ${coin.nice?.score}</span>
                        <span class="text-gray-400">Kelly ${coin.trading?.kelly_pct}%</span>
                    </div>
                </div>
            `;
        }

        function formatVolume(vol) {
            if (vol >= 1e9) return `$${(vol / 1e9).toFixed(1)}B`;
            if (vol >= 1e6) return `$${(vol / 1e6).toFixed(0)}M`;
            return `$${vol?.toFixed(0) || 0}`;
        }

        // CoinGecko API ID ë§¤í•‘
        function getCoinGeckoId(symbol) {
            const idMap = {
                'BTC': 'bitcoin', 'ETH': 'ethereum', 'SOL': 'solana',
                'XRP': 'ripple', 'BNB': 'binancecoin', 'DOGE': 'dogecoin',
                'ADA': 'cardano', 'AVAX': 'avalanche-2', 'DOT': 'polkadot',
                'LINK': 'chainlink', 'MATIC': 'matic-network', 'SHIB': 'shiba-inu',
                'PEPE': 'pepe', 'BONK': 'bonk', 'WIF': 'dogwifcoin', 'FLOKI': 'floki',
                'SUI': 'sui', 'OP': 'optimism', 'ARB': 'arbitrum', 'NEAR': 'near',
                'APT': 'aptos', 'UNI': 'uniswap', 'TRX': 'tron', 'TON': 'the-open-network'
            };
            return idMap[symbol.toUpperCase()] || symbol.toLowerCase();
        }

        // ì½”ì¸ ì„ íƒ ë° UI ì—…ë°ì´íŠ¸ (API ì—°ë™ - ëª¨ë“  ì½”ì¸ ì§€ì›)
        async function selectCoin(symbol) {
            selectedCoin = symbol;

            // 1. ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            initTradingView(symbol, currentTimeframe);

            // 2. ì¹´ë“œ í•˜ì´ë¼ì´íŠ¸
            document.querySelectorAll('.coin-card').forEach(card => {
                if (card.dataset.symbol === symbol) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });

            // 3. ìŠ¤ì¼ˆë ˆí†¤ ë¡œë”© ìƒíƒœ ì„¤ì • (NEW)
            const dataFieldIds = [
                'ai-circulation', 'ai-supply', 'ai-whale', 'ai-whale-detail',
                'ai-fractal', 'ai-fractal-detail', 'ai-entry', 'ai-sl', 'ai-tp'
            ];
            setLoadingState(dataFieldIds);

            // 4. APIì—ì„œ ì½”ì¸ ë¶„ì„ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ìºì‹œ ì‚¬ìš©)
            try {
                const data = await cachedFetch(`/api/crypto/analysis/${symbol}`);

                if (data.error) {
                    showToast(`${symbol} ë¶„ì„ ì˜¤ë¥˜: ${data.error}`, 'error');
                    dataFieldIds.forEach(id => setDataField(id, null, { fallback: 'ì˜¤ë¥˜' }));
                    return;
                }

                // ê°€ê²© ë°ì´í„° í™•ë³´ (fallback ë¡œì§)
                let price = data.price || 0;
                let change = data.change_24h || 0;

                // ê°€ê²©ì´ ì—†ìœ¼ë©´ marketMapDataì—ì„œ ì°¾ê¸°
                if (!price || price === 0) {
                    const mapCoin = marketMapData.find(c => c.symbol === symbol);
                    if (mapCoin && mapCoin.price) {
                        price = mapCoin.price;
                    }
                    if (mapCoin && mapCoin.change) {
                        change = mapCoin.change;
                    }
                }

                // ì—¬ì „íˆ ê°€ê²©ì´ ì—†ìœ¼ë©´ CoinGeckoì—ì„œ ê°€ì ¸ì˜¤ê¸° (ìºì‹œ ì‚¬ìš©)
                if (!price || price === 0) {
                    try {
                        const cgData = await cachedFetch(`https://api.coingecko.com/api/v3/simple/price?ids=${getCoinGeckoId(symbol)}&vs_currencies=usd&include_24hr_change=true`);
                        const coinId = getCoinGeckoId(symbol);
                        if (cgData[coinId]) {
                            price = cgData[coinId].usd || 0;
                            change = cgData[coinId].usd_24h_change || 0;
                        }
                    } catch (cgErr) {
                        console.warn('CoinGecko fallback failed:', cgErr);
                    }
                }

                // ìƒë‹¨ ì •ë³´ ì—…ë°ì´íŠ¸ (ìƒˆ ìœ í‹¸ë¦¬í‹° ì‚¬ìš©)
                setDataField('chart-symbol', data.symbol || symbol);
                setDataField('chart-name', data.name || symbol);
                setDataField('chart-price', price ? formatPrice(price) : null);

                const changeEl = document.getElementById('chart-change');
                if (changeEl) {
                    changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(1)}%`;
                    changeEl.className = change >= 0 ? 'text-emerald-400 text-sm' : 'text-red-400 text-sm';
                }

                setDataField('selected-coin-name', `${data.symbol || symbol} ${data.name || ''}`);

                // AI ë¶„ì„ íŒ¨ë„ ì—…ë°ì´íŠ¸ (ê°œì„ ëœ fallback ë©”ì‹œì§€)
                setDataField('ai-circulation', data.circulation, { suffix: '%', fallback: 'ê³„ì‚° ì¤‘...' });
                setDataField('ai-supply', data.circulating ? formatLargeNumber(data.circulating) : null, { fallback: 'í™•ì¸ ì¤‘...' });

                // ê³ ë˜ í¬ì§€ì…˜
                setDataField('ai-whale', data.whale, { fallback: 'ë¶„ì„ ì¤‘...' });
                setDataField('ai-whale-detail', data.whale_wallets ? `${data.whale_wallets} ì§€ê°‘, ${data.whale_holding_pct?.toFixed(1) || 0}%` : null);

                // í”„ë ‰íƒˆ
                setDataField('ai-fractal', data.fractal, { fallback: 'ë¶„ì„ ì¤‘...' });
                setDataField('ai-fractal-detail', data.fractal_strength ? `ê°•ë„ ${data.fractal_strength}%` : null);

                // ê±°ë˜ ì¶”ì²œ (ëª¨ë“  ì½”ì¸ì—ì„œ ì‘ë™ - price ê¸°ë°˜ ê³„ì‚°)
                const entryPrice = data.entry_price || (price * 0.98);
                const stopLoss = data.stop_loss || (price * 0.95);
                const takeProfit = data.take_profit || (price * 1.05);

                setDataField('ai-entry', price ? formatPrice(entryPrice) : null, { fallback: 'ëŒ€ê¸°' });
                setDataField('ai-sl', price ? formatPrice(stopLoss) : null, { fallback: 'ëŒ€ê¸°' });
                setDataField('ai-tp', price ? formatPrice(takeProfit) : null, { fallback: 'ëŒ€ê¸°' });

                // 5. íŒŒë™ ë¶„ì„ íŒ¨ë„ ì—…ë°ì´íŠ¸ (ê°€ê²© ë°ì´í„° í•„ìˆ˜)
                if (price > 0) {
                    updateWaveAnalysis(symbol, price, change, data);
                }

                // 6. ì‹œì¥ í†µê³„ íŒ¨ë„ ì—…ë°ì´íŠ¸
                updateMarketStats(symbol, data);

            } catch (e) {
                console.error('selectCoin API error:', e);
                showToast(`${symbol} ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨`, 'error');

                // í´ë°±: ê¸°ë³¸ í‘œì‹œ with ì—ëŸ¬ ë©”ì‹œì§€
                setDataField('chart-symbol', symbol);
                setDataField('chart-name', symbol);
                setDataField('selected-coin-name', symbol);
                dataFieldIds.forEach(id => setDataField(id, null, { fallback: 'ì˜¤í”„ë¼ì¸' }));
            }
        }

        // Elliott Wave / Fibonacci / Trendline ë¶„ì„ ì—…ë°ì´íŠ¸ (REAL OHLC DATA)
        async function updateWaveAnalysis(symbol, price, change, data) {
            // íŒŒë™ ë¶„ì„ ì½”ì¸ ì´ë¦„ ì—…ë°ì´íŠ¸
            document.getElementById('wave-coin-name').textContent = `(${symbol}) ë¡œë”© ì¤‘...`;

            try {
                // Fetch real technical data from backend
                const techRes = await fetch(`/api/crypto/technical/${symbol}`);
                const techData = await techRes.json();

                // Update coin name with source indicator
                const sourceLabel = techData.source === 'CoinGecko OHLC' ? 'âœ“ ì‹¤ì‹œê°„' : 'âš  ì¶”ì •ì¹˜';
                document.getElementById('wave-coin-name').textContent = `(${symbol}) ${sourceLabel}`;

                // Elliott Wave ë¶„ì„ (7ì¼ ì¶”ì„¸ ê¸°ë°˜ - ì‹¤ì œ ë°ì´í„°)
                const elliott = techData.elliott || {};
                const currentWave = elliott.wave || 1;
                const wavePosition = elliott.description || 'Wave 1 ì‹œì‘';

                // 7ì¼ ì¶”ì„¸ ê¸°ë°˜ ìƒì„¸ ì„¤ëª…
                const trendDir = techData.trend_direction || 'unknown';
                const weeklyChange = techData.weekly_change || 0;
                let waveDetail;
                if (trendDir === 'strong_bull') {
                    waveDetail = `7ì¼ ë³€ë™: +${weeklyChange.toFixed(1)}%<br>ê°•í•œ ìƒìŠ¹ ëª¨ë©˜í…€`;
                } else if (trendDir === 'bull') {
                    waveDetail = `7ì¼ ë³€ë™: +${weeklyChange.toFixed(1)}%<br>ìƒìŠ¹ ì¶”ì„¸ ì§„í–‰`;
                } else if (trendDir === 'neutral_up') {
                    waveDetail = `7ì¼ ë³€ë™: +${weeklyChange.toFixed(1)}%<br>ì•½í•œ ìƒìŠ¹ / ê´€ë§`;
                } else if (trendDir === 'neutral_down') {
                    waveDetail = `7ì¼ ë³€ë™: ${weeklyChange.toFixed(1)}%<br>ì•½í•œ í•˜ë½ / ì¡°ì •`;
                } else if (trendDir === 'bear') {
                    waveDetail = `7ì¼ ë³€ë™: ${weeklyChange.toFixed(1)}%<br>í•˜ë½ ì¶”ì„¸ ì§„í–‰`;
                } else {
                    waveDetail = `7ì¼ ë³€ë™: ${weeklyChange.toFixed(1)}%<br>ê°•í•œ í•˜ë½ / ê²½ê³ `;
                }

                document.getElementById('elliott-position').textContent = wavePosition;
                document.getElementById('elliott-detail').innerHTML = waveDetail;

                // íŒŒë™ ë²„íŠ¼ í•˜ì´ë¼ì´íŠ¸
                const waveButtonsContainer = document.getElementById('current-wave')?.parentElement;
                if (waveButtonsContainer) {
                    const waveButtons = waveButtonsContainer.children;
                    for (let i = 0; i < waveButtons.length; i++) {
                        if (i + 1 === currentWave) {
                            waveButtons[i].className = 'px-2 py-0.5 bg-purple-500 text-white rounded text-xs font-bold';
                        } else if (i + 1 < currentWave) {
                            waveButtons[i].className = 'px-2 py-0.5 bg-purple-500/20 text-purple-300 rounded text-xs';
                        } else {
                            waveButtons[i].className = 'px-2 py-0.5 bg-gray-700 text-gray-400 rounded text-xs';
                        }
                    }
                }

                // Fibonacci ë ˆë²¨ ê³„ì‚° (24H High/Low ì¶”ì • - ë³€ë™ë¥  ê¸°ë°˜)
                const fib = techData.fibonacci || {};
                const ohlc = techData.ohlc || {};

                // ì‹¤ì œ high/lowê°€ ì—†ìœ¼ë©´ change ê¸°ë°˜ìœ¼ë¡œ ì¶”ì •
                const changeAbs = Math.abs(change) || 2;
                const high = ohlc.high_24h || (price * (1 + changeAbs / 100 + 0.02));
                const low = ohlc.low_24h || (price * (1 - changeAbs / 100 - 0.02));
                const currentPrice = techData.current_price || price;
                const range = high - low;

                // Format price helper
                const formatPrice = (p) => {
                    if (p >= 1000) return `$${p.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
                    if (p >= 1) return `$${p.toLocaleString(undefined, { maximumFractionDigits: 2 })}`;
                    return `$${p.toLocaleString(undefined, { maximumFractionDigits: 6 })}`;
                };

                document.getElementById('fib-0').textContent = formatPrice(fib['0'] || low);
                document.getElementById('fib-236').textContent = formatPrice(fib['236'] || (low + range * 0.236));
                document.getElementById('fib-382').textContent = formatPrice(fib['382'] || (low + range * 0.382));
                document.getElementById('fib-50').textContent = formatPrice(fib['500'] || (low + range * 0.5));
                document.getElementById('fib-618').textContent = formatPrice(fib['618'] || (low + range * 0.618));
                document.getElementById('fib-100').textContent = formatPrice(fib['1000'] || high);

                // í˜„ì¬ Fibonacci ìœ„ì¹˜ (ì‹¤ì œ ê°€ê²© ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°)
                let fibLevel = techData.fib_position;
                if (fibLevel === undefined || fibLevel === 50) {
                    // APIê°€ 50ì„ ë°˜í™˜í–ˆìœ¼ë©´ ì§ì ‘ ê³„ì‚°
                    fibLevel = range > 0 ? ((currentPrice - low) / range * 100) : 50;
                }

                let fibPosition;
                if (fibLevel >= 78.6) fibPosition = `${fibLevel.toFixed(1)}% ìƒë‹¨ (ê³¼ë§¤ìˆ˜)`;
                else if (fibLevel >= 61.8) fibPosition = `${fibLevel.toFixed(1)}% ì €í•­ í…ŒìŠ¤íŠ¸`;
                else if (fibLevel >= 50) fibPosition = `${fibLevel.toFixed(1)}% ì¤‘ì‹¬ ì˜ì—­`;
                else if (fibLevel >= 38.2) fibPosition = `${fibLevel.toFixed(1)}% ì§€ì§€ ì˜ì—­`;
                else if (fibLevel >= 23.6) fibPosition = `${fibLevel.toFixed(1)}% í•˜ë‹¨`;
                else fibPosition = `${fibLevel.toFixed(1)}% ì €ì  í…ŒìŠ¤íŠ¸`;
                document.getElementById('fib-position').textContent = fibPosition;

                // ì¶”ì„¸ì„  ë¶„ì„ (ì‹¤ì œ Support/Resistance)
                const support = techData.support || (currentPrice * 0.95);
                const resistance = techData.resistance || (currentPrice * 1.05);
                document.getElementById('trend-current').textContent = formatPrice(currentPrice);
                document.getElementById('trend-support').textContent = formatPrice(support);
                document.getElementById('trend-resistance').textContent = formatPrice(resistance);

                // ì¶”ì„¸ ìƒíƒœ (7ì¼ ì¶”ì„¸ ê¸°ë°˜)
                let trendStatus;
                if (trendDir === 'strong_bull') trendStatus = 'ğŸš€ ê°•í•œ ìƒìŠ¹ ì¶”ì„¸';
                else if (trendDir === 'bull') trendStatus = 'ğŸ“ˆ ìƒìŠ¹ ì¶”ì„¸ ìœ ì§€';
                else if (trendDir === 'neutral_up') trendStatus = 'â¡ï¸ ì•½ì„¸ ìƒìŠ¹';
                else if (trendDir === 'neutral_down') trendStatus = 'â¡ï¸ íš¡ë³´/ì¡°ì •';
                else if (trendDir === 'bear') trendStatus = 'ğŸ“‰ í•˜ë½ ì¶”ì„¸';
                else trendStatus = 'âš ï¸ ê°•í•œ í•˜ë½';
                document.getElementById('trend-status').textContent = trendStatus;

                // ì¶”ì„¸ ê°•ë„ (ì‹¤ì œ ë°ì´í„° ê¸°ë°˜)
                const strength = techData.trend_strength || 50;
                document.getElementById('trend-strength').textContent = `${strength.toFixed(0)}%`;
                document.getElementById('trend-strength-bar').style.width = `${strength}%`;

            } catch (e) {
                console.error('Wave analysis fetch error:', e);

                // Fallback: ê¸°ì¡´ ë¡œì§ ì‚¬ìš©
                document.getElementById('wave-coin-name').textContent = `(${symbol}) âš  ì˜¤í”„ë¼ì¸`;

                // ê°„ë‹¨í•œ change ê¸°ë°˜ fallback
                const currentWave = change > 5 ? 3 : (change > 0 ? 1 : 2);
                document.getElementById('elliott-position').textContent = `Wave ${currentWave} (ì˜ˆì¸¡)`;
                document.getElementById('elliott-detail').innerHTML = 'ì‹¤ì‹œê°„ ë°ì´í„° ì‚¬ìš© ë¶ˆê°€<br>API ì˜¤ë¥˜';
            }
        }

        // ğŸ“Š ì‹œì¥ í†µê³„ íŒ¨ë„ ì—…ë°ì´íŠ¸ (CoinGecko API ì—°ë™)
        async function updateMarketStats(symbol, apiData) {
            try {
                // ì½”ì¸ ì´ë¦„ ì—…ë°ì´íŠ¸
                document.getElementById('stats-coin-name').textContent = symbol;

                // ê¸°ë³¸ ë°ì´í„° ë¨¼ì € í‘œì‹œ (API ë°ì´í„°)
                if (apiData.market_cap) {
                    const marketCap = apiData.market_cap;
                    document.getElementById('stats-market-cap').textContent =
                        marketCap >= 1e12 ? `${(marketCap / 1e12).toFixed(2)}T` :
                            marketCap >= 1e9 ? `${(marketCap / 1e9).toFixed(2)}B` :
                                `${(marketCap / 1e6).toFixed(2)}M`;
                }

                // CoinGeckoì—ì„œ ìƒì„¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const coinId = getCoinGeckoId(symbol);
                const cgUrl = `https://api.coingecko.com/api/v3/coins/${coinId}?localization=false&tickers=false&community_data=false&developer_data=false`;

                const res = await fetch(cgUrl);
                const data = await res.json();

                if (data.market_data) {
                    const md = data.market_data;

                    // ê±°ë˜ëŸ‰
                    const volume = md.total_volume?.usd || 0;
                    document.getElementById('stats-volume').textContent =
                        volume >= 1e9 ? `${(volume / 1e9).toFixed(2)}B` : `${(volume / 1e6).toFixed(2)}M`;

                    // í‰ê·  ë³¼ë¥¨ (30ì¼ = ì´ ê±°ë˜ëŸ‰ / 30 ê·¼ì‚¬)
                    const avgVolume = volume * 0.9; // ê·¼ì‚¬ê°’
                    document.getElementById('stats-avg-volume').textContent =
                        avgVolume >= 1e9 ? `${(avgVolume / 1e9).toFixed(2)}B` : `${(avgVolume / 1e6).toFixed(2)}M`;

                    // ì‹œê°€ì´ì•¡
                    const marketCap = md.market_cap?.usd || 0;
                    document.getElementById('stats-market-cap').textContent =
                        marketCap >= 1e12 ? `${(marketCap / 1e12).toFixed(2)}T` :
                            marketCap >= 1e9 ? `${(marketCap / 1e9).toFixed(2)}B` :
                                `${(marketCap / 1e6).toFixed(2)}M`;

                    // ì„±ê³¼ íƒ€ì¼ ì—…ë°ì´íŠ¸
                    updatePerfTile('perf-1w', md.price_change_percentage_7d);
                    updatePerfTile('perf-1m', md.price_change_percentage_30d);
                    updatePerfTile('perf-3m', md.price_change_percentage_60d); // 2M ê·¼ì‚¬
                    updatePerfTile('perf-6m', md.price_change_percentage_200d); // ê·¼ì‚¬
                    updatePerfTile('perf-ytd', md.price_change_percentage_1y * 0.8); // ê·¼ì‚¬
                    updatePerfTile('perf-1y', md.price_change_percentage_1y);
                }

                // ì¶œì²˜ & íƒ€ì„ìŠ¤íƒ¬í”„
                document.getElementById('stats-source').textContent = 'CoinGecko API';
                document.getElementById('stats-timestamp').textContent =
                    `ë§ˆì§€ë§‰ ê°±ì‹ : ${new Date().toLocaleTimeString('ko-KR')}`;

            } catch (e) {
                console.warn('Market stats update error:', e);
            }
        }

        // ì„±ê³¼ íƒ€ì¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ í—¬í¼
        function updatePerfTile(elementId, value) {
            const el = document.getElementById(elementId);
            if (!el) return;

            const numValue = parseFloat(value) || 0;
            const displayValue = numValue.toFixed(2) + '%';
            const colorClass = numValue > 0 ? 'text-emerald-400' : (numValue < 0 ? 'text-red-400' : 'text-gray-400');
            const bgClass = numValue > 0 ? 'bg-emerald-500/20' : (numValue < 0 ? 'bg-red-500/20' : 'bg-gray-700');

            el.innerHTML = `
                <div class="text-lg font-bold ${colorClass}">${numValue > 0 ? '+' : ''}${displayValue}</div>
                <div class="text-xs text-gray-500">${el.querySelector('.text-gray-500')?.textContent || ''}</div>
            `;
            el.className = `glass-card p-2 text-center ${bgClass}`;
        }

        // í—¤ë” ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë“œ (ìºì‹œ ì‚¬ìš©)
        async function loadHeaderData() {
            try {
                const data = await cachedFetch('/api/crypto/real-time');

                if (data.error) {
                    console.warn('Header data error:', data.error);
                    return;
                }

                setDataField('top-signal', data.top_signal);
                setDataField('type-a-count', data.type_a_count, { suffix: 'ê°œ' });
                setDataField('next-report', data.next_report);
                setDataField('avg-kelly', data.avg_kelly, { suffix: '%' });
                setDataField('fear-greed', data.fear_greed ? `${data.fear_greed.value} ${data.fear_greed.label}` : null);
                setDataField('net-flow', data.net_flow ? `${data.net_flow.direction === 'in' ? '+' : '-'}$${Math.abs(data.net_flow.value).toFixed(1)}B` : null);
                setDataField('main-score', data.main_score, { suffix: 'ì ' });

                // Type ë°°ì§€ ì—…ë°ì´íŠ¸
                const typeBadge = document.getElementById('main-type');
                if (typeBadge && data.main_type) {
                    typeBadge.textContent = `Type ${data.main_type}`;
                    typeBadge.className = `type-badge type-${data.main_type.toLowerCase()}`;
                }

            } catch (e) {
                console.error('Header data error:', e);
            }
        }

        // ì „ë¬¸ê°€ ë¶„ì„ ë¡œë“œ (ê³¼ê±°â†’í˜„ì¬â†’ë¯¸ë˜ + NICE ë ˆì´ì–´ë³„ ë¶„ì„)
        async function loadExpertAnalysis() {
            const container = document.getElementById('expert-views');
            container.innerHTML = '<div class="text-center text-gray-400 py-4">ğŸ”„ NICE ë ˆì´ì–´ ë¶„ì„ ì¤‘...</div>';

            try {
                const res = await fetch('/api/nice/experts');
                const data = await res.json();

                if (data.error) {
                    container.innerHTML = '<div class="text-red-400">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
                    return;
                }

                let html = '';

                // ========== 1. íƒ€ì„ë¼ì¸ ë¶„ì„ (ê³¼ê±°â†’í˜„ì¬â†’ë¯¸ë˜) ==========
                if (data.timeline) {
                    const tl = data.timeline;
                    html += `
                        <div class="glass-card p-4 mb-4">
                            <h4 class="font-bold text-white mb-3">ğŸ“Š ì‹œì¥ íƒ€ì„ë¼ì¸ ë¶„ì„</h4>
                            <div class="space-y-3">
                                <div class="flex items-start gap-3">
                                    <span class="text-gray-500 font-bold min-w-[60px]">ğŸ“œ ê³¼ê±°</span>
                                    <span class="text-gray-300 text-sm">${tl.past}</span>
                                </div>
                                <div class="flex items-start gap-3">
                                    <span class="text-emerald-400 font-bold min-w-[60px]">ğŸ“ í˜„ì¬</span>
                                    <span class="text-emerald-300 text-sm">${tl.present}</span>
                                </div>
                                <div class="flex items-start gap-3">
                                    <span class="text-cyan-400 font-bold min-w-[60px]">ğŸ”® ë¯¸ë˜</span>
                                    <span class="text-cyan-300 text-sm">${tl.future}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // ========== 2. NICE ë ˆì´ì–´ë³„ ë¶„ì„ ==========
                if (data.layer_analysis) {
                    const layers = data.layer_analysis;
                    html += '<div class="glass-card p-4 mb-4"><h4 class="font-bold text-white mb-3">ğŸ“ˆ NICE 5-Layer ìƒì„¸ ë¶„ì„</h4><div class="space-y-3">';

                    const layerKeys = ['layer1_technical', 'layer2_onchain', 'layer3_sentiment', 'layer4_macro', 'layer5_institutional'];
                    const layerColors = ['#8b5cf6', '#10b981', '#f59e0b', '#3b82f6', '#ec4899'];

                    layerKeys.forEach((key, idx) => {
                        const layer = layers[key];
                        if (layer) {
                            const pct = (layer.score / layer.max * 100).toFixed(0);
                            const statusColor = layer.status.includes('ê°•ì„¸') || layer.status.includes('ì¶•ì ') || layer.status.includes('ìš°í˜¸') || layer.status.includes('ë§¤ì§‘') || layer.status.includes('íƒìš•')
                                ? '#10b981' : (layer.status.includes('ì•½ì„¸') || layer.status.includes('ë¶„ë°°') || layer.status.includes('ë¹„ìš°í˜¸') || layer.status.includes('ë§¤ë„') || layer.status.includes('ê³µí¬') ? '#ef4444' : '#eab308');

                            html += `
                                <div class="bg-gray-800/50 rounded-lg p-3 border-l-4" style="border-color: ${layerColors[idx]}">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="font-bold text-white text-sm">${layer.name}</span>
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs px-2 py-0.5 rounded" style="background: ${statusColor}20; color: ${statusColor}">${layer.status}</span>
                                            <span class="text-white font-bold">${layer.score}/${layer.max}</span>
                                        </div>
                                    </div>
                                    <div class="w-full bg-gray-700 rounded-full h-1.5 mb-2">
                                        <div class="h-1.5 rounded-full" style="width: ${pct}%; background: ${layerColors[idx]}"></div>
                                    </div>
                                    <div class="grid grid-cols-3 gap-2 text-xs">
                                        <div><span class="text-gray-500">ê³¼ê±°</span><p class="text-gray-400 mt-0.5">${layer.past}</p></div>
                                        <div><span class="text-emerald-500">í˜„ì¬</span><p class="text-gray-300 mt-0.5">${layer.present}</p></div>
                                        <div><span class="text-cyan-500">ë¯¸ë˜</span><p class="text-gray-400 mt-0.5">${layer.future}</p></div>
                                    </div>
                                </div>
                            `;
                        }
                    });

                    html += '</div></div>';
                }

                // ========== 3. ì „ë¬¸ê°€ ì˜ê²¬ ==========
                const experts = data.experts || [];
                if (experts.length > 0) {
                    html += '<div class="glass-card p-4"><h4 class="font-bold text-white mb-3">ğŸ‘” ì „ë¬¸ê°€ ì˜ê²¬</h4><div class="grid grid-cols-2 gap-2">';

                    experts.forEach(exp => {
                        const signal = exp.signal || '';
                        let signalClass = 'text-gray-400';
                        if (signal.includes('ê°•í•œ ë§¤ìˆ˜') || signal.includes('ë§¤ìˆ˜')) signalClass = 'text-emerald-400';
                        else if (signal.includes('ë§¤ë„')) signalClass = 'text-red-400';
                        else if (signal.includes('ì¤‘ë¦½') || signal.includes('ê´€ë§')) signalClass = 'text-yellow-400';

                        html += `
                            <div class="bg-gray-800/30 rounded p-2">
                                <div class="flex justify-between items-center">
                                    <span class="font-bold text-white text-xs">${exp.expert || exp.name}</span>
                                    <span class="${signalClass} font-bold text-xs">${exp.signal}</span>
                                </div>
                                <div class="text-[10px] text-gray-500 mt-1">${exp.action || ''}</div>
                            </div>
                        `;
                    });

                    html += '</div>';

                    // ì»¨ì„¼ì„œìŠ¤
                    if (data.consensus) {
                        const consensusClass = data.consensus.signal?.includes('ë§¤ìˆ˜') ? 'text-emerald-400' : 'text-yellow-400';
                        html += `
                            <div class="mt-3 p-2 border border-emerald-500/30 rounded-lg flex justify-between items-center">
                                <span class="font-bold text-emerald-400">ğŸ“Š ì»¨ì„¼ì„œìŠ¤</span>
                                <div>
                                    <span class="${consensusClass} font-bold">${data.consensus.signal}</span>
                                    <span class="text-gray-500 text-xs ml-2">(ì‹ ë¢°ë„ ${data.consensus.confidence?.toFixed(0) || 0}%)</span>
                                </div>
                            </div>
                        `;
                    }
                    html += '</div>';
                }

                container.innerHTML = html || '<div class="text-gray-400 text-center py-4">ë¶„ì„ ë°ì´í„° ì—†ìŒ</div>';
            } catch (e) {
                console.error('Expert analysis error:', e);
                container.innerHTML = `
                    <div class="text-red-400 text-center py-4">ì „ë¬¸ê°€ ë¶„ì„ ë¡œë“œ ì‹¤íŒ¨</div>
                `;
            }
        }

        // ìˆœìœ„ ë¡œë“œ (Timeframe íŒŒë¼ë¯¸í„° ì ìš©) + ìƒìœ„ 10ì½”ì¸ 00:00 ê¸°ì¤€ ë³€í™”ëŸ‰
        async function loadRankings(timeframe = 'scalp') {
            try {
                // UI ë¡œë”© í‘œì‹œ
                const loadingHtml = '<div class="text-center text-gray-500 py-4 pulse">ë°ì´í„° ë¶„ì„ ì¤‘...</div>';
                document.getElementById('major-coins-list').innerHTML = loadingHtml;
                document.getElementById('other-coins-list').innerHTML = loadingHtml;
                document.getElementById('market-map').innerHTML = loadingHtml;

                const res = await fetch(`/api/crypto/rankings?timeframe=${timeframe}`);
                const data = await res.json();

                if (data.error) {
                    console.error('Rankings error:', data.error);
                    return;
                }

                // ë©”ì´ì € ì½”ì¸
                document.getElementById('major-coins-list').innerHTML =
                    data.major?.map((coin, idx) => renderCoinCard(coin, idx, true)).join('') || '<div class="text-gray-400">ë°ì´í„° ì—†ìŒ</div>';

                // ê¸°íƒ€ ì½”ì¸
                document.getElementById('other-coins-list').innerHTML =
                    data.other?.map((coin, idx) => renderCoinCard(coin, idx, false)).join('') || '<div class="text-gray-400">ë°ì´í„° ì—†ìŒ</div>';

                // Market Map ì—…ë°ì´íŠ¸ (ìˆœìœ„ ë°ì´í„° ê¸°ë°˜ - 24h ë³€ë™ë¥  ì‚¬ìš©)
                const allCoins = [...(data.major || []), ...(data.other || [])];

                // Market Map ë°ì´í„° í˜•ì‹ ë³€í™˜ (24h ê¸°ì¤€ - ì•ˆì •ì )
                // NOTE: 00:00 ê¸°ì¤€ ì—…ë°ì´íŠ¸ëŠ” CoinGecko API ë¶ˆì•ˆì •ìœ¼ë¡œ ë¹„í™œì„±í™”
                marketMapData = allCoins.map(coin => ({
                    symbol: coin.symbol,
                    name: coin.name,
                    change: coin.change_24h,
                    sector: coin.sector || 'Other',
                    size: coin.is_major ? 4 : 2,
                    isMidnight: false
                })).sort((a, b) => Math.abs(b.change) - Math.abs(a.change));

                // ë Œë”ë§ (í•œ ë²ˆë§Œ)
                renderMarketMap();

            } catch (e) {
                console.error('Rankings load error:', e);
            }
        }

        // ========== ì´ˆ ê¸‰ë“± (Super Surge) ë¡œë“œ ==========
        async function loadSuperSurge() {
            try {
                // UI ë¡œë”© ìƒíƒœ
                document.getElementById('surge-coins-list').innerHTML =
                    '<div class="text-gray-400 text-center py-8 col-span-2">ğŸ”„ ê¸‰ë“± ì½”ì¸ ë¶„ì„ ì¤‘...</div>';
                document.getElementById('surge-ai-insights').innerHTML =
                    '<div class="text-gray-400">ğŸ¤– AI ë¶„ì„ ì§„í–‰ ì¤‘... (Perplexity sonar-pro)</div>';

                const res = await fetch('/api/crypto/super-surge');
                const data = await res.json();

                if (data.error) {
                    console.error('Super Surge error:', data.error);
                    document.getElementById('surge-coins-list').innerHTML =
                        `<div class="text-red-400 text-center py-8 col-span-2">ì˜¤ë¥˜: ${data.error}</div>`;
                    return;
                }

                // 1. ì„¸ì…˜ ì •ë³´ ì—…ë°ì´íŠ¸
                const session = data.session;
                document.getElementById('surge-session-name').textContent =
                    `${session.current.emoji} ${session.current.name}`;
                document.getElementById('surge-session-details').textContent =
                    `ìœ ë™ì„±: ${session.current.liquidity} | ë³€ë™ì„±: ${session.current.volatility} | ì‹œì‘: ${session.current.start_time}`;
                document.getElementById('surge-countdown').textContent = session.next.formatted;
                document.getElementById('surge-next-session').textContent =
                    `${session.next.emoji} ${session.next.name}`;

                // 2. ê¸‰ë“± ì½”ì¸ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
                const surgeCoins = data.surge_candidates || [];
                if (surgeCoins.length === 0) {
                    document.getElementById('surge-coins-list').innerHTML =
                        '<div class="text-gray-400 text-center py-8 col-span-2">í˜„ì¬ ê¸‰ë“± ì¤‘ì¸ ì½”ì¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                } else {
                    document.getElementById('surge-coins-list').innerHTML = surgeCoins.map(coin => {
                        const changeColor = coin.change_5m >= 0 ? 'text-emerald-400' : 'text-red-400';
                        const signalColor = coin.quick_score >= 80 ? 'bg-emerald-600' :
                            (coin.quick_score >= 60 ? 'bg-yellow-600' : 'bg-gray-600');
                        return `
                            <div class="glass-card p-3 rounded-lg cursor-pointer hover:bg-white/5 transition"
                                 onclick="selectCoin('${coin.symbol}')">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span class="font-bold">${coin.symbol}</span>
                                        <span class="text-gray-400 text-xs ml-1">${coin.name || ''}</span>
                                    </div>
                                    <span class="${signalColor} px-2 py-0.5 rounded text-xs font-bold">
                                        ${coin.surge_signal}
                                    </span>
                                </div>
                                <div class="flex items-center justify-between mt-2 text-sm">
                                    <span class="text-gray-400">5ë¶„ ë³€ë™</span>
                                    <span class="${changeColor} font-bold">
                                        ${coin.change_5m >= 0 ? '+' : ''}${coin.change_5m.toFixed(2)}%
                                    </span>
                                </div>
                                <div class="flex items-center justify-between text-sm">
                                    <span class="text-gray-400">Quick Score</span>
                                    <span class="font-bold">${coin.quick_score}/100</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // 3. í†µê³„ ì—…ë°ì´íŠ¸
                document.getElementById('surge-analyzed-count').textContent =
                    `ë¶„ì„ëœ ì½”ì¸: ${data.total_analyzed}ê°œ (ê¸‰ë“±: ${data.surge_count}ê°œ)`;
                document.getElementById('surge-reliability').textContent =
                    `Palantir ì‹ ë¢°ë„: ${(data.palantir_reliability * 100).toFixed(1)}%`;

                // 4. AI ì¸ì‚¬ì´íŠ¸ ë Œë”ë§
                const aiInsights = data.ai_insights;
                if (aiInsights && aiInsights.analysis) {
                    document.getElementById('surge-ai-insights').innerHTML = `
                        <div class="bg-purple-900/30 p-3 rounded-lg">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-purple-400 font-bold">ğŸ“ ${aiInsights.analyzed_symbol || 'BTC'} ë¶„ì„</span>
                                <span class="text-xs text-gray-500">| Perplexity sonar-pro</span>
                            </div>
                            <div class="whitespace-pre-wrap text-sm leading-relaxed">
                                ${aiInsights.analysis}
                            </div>
                            ${aiInsights.citations && aiInsights.citations.length > 0 ?
                            `<div class="mt-2 text-xs text-gray-500">
                                    ì¶œì²˜: ${aiInsights.citations.slice(0, 3).join(', ')}
                                </div>` : ''}
                        </div>
                    `;
                } else if (aiInsights && aiInsights.error) {
                    document.getElementById('surge-ai-insights').innerHTML =
                        `<div class="text-yellow-400">âš ï¸ AI ë¶„ì„ ì˜¤ë¥˜: ${aiInsights.error}</div>`;
                } else {
                    document.getElementById('surge-ai-insights').innerHTML =
                        '<div class="text-gray-400">AI ë¶„ì„ ë°ì´í„° ì—†ìŒ (API í‚¤ í™•ì¸ í•„ìš”)</div>';
                }

                console.log('Super Surge loaded:', data);

            } catch (e) {
                console.error('Super Surge load error:', e);
                document.getElementById('surge-coins-list').innerHTML =
                    `<div class="text-red-400 text-center py-8 col-span-2">ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`;
            }
        }

        // ì¹´í…Œê³ ë¦¬ íƒ­ ì „í™˜ ë° ë°ì´í„° ë¦¬ë¡œë“œ

        // ========== Market Analysis (Market Gate / Lead-Lag) ==========
        const MarketAnalysis = {
            // Market Gate ë¡œë”©
            async loadMarketGate() {
                const container = document.getElementById('market-gate-section');
                if (!container) return;

                try {
                    const res = await fetch('/api/crypto/market-gate');
                    const data = await res.json();

                    if (data.error) {
                        container.innerHTML = `<div class="text-red-400">${data.error}</div>`;
                        return;
                    }

                    const gateColor = data.gate_color === 'GREEN' ? '#10b981' :
                        data.gate_color === 'YELLOW' ? '#f59e0b' : '#ef4444';

                    container.innerHTML = `
                        <div class="glass-card rounded-3xl p-4">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h2 class="text-xl font-black">Market Gate Analysis</h2>
                                    <p class="text-gray-500 text-sm mt-1">${data.summary}</p>
                                </div>
                                
                                <div class="relative w-24 h-24">
                                    <svg class="w-full h-full -rotate-90">
                                        <circle cx="48" cy="48" r="40" fill="none" 
                                                stroke="rgba(255,255,255,0.05)" stroke-width="6"/>
                                        <circle cx="48" cy="48" r="40" fill="none" 
                                                stroke="${gateColor}" stroke-width="6" stroke-linecap="round"
                                                stroke-dasharray="251" 
                                                stroke-dashoffset="${251 * (1 - data.score / 100)}"
                                                style="transition: stroke-dashoffset 1s ease-out"/>
                                    </svg>
                                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                                        <span class="text-2xl font-black">${data.score}</span>
                                        <span class="text-xs font-bold px-2 py-0.5 rounded-full" 
                                            style="background: ${gateColor}20; color: ${gateColor}">
                                            ${data.gate_color}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="gate-indicators">
                                ${this.renderIndicators(data.indicators)}
                            </div>
                        </div>
                    `;
                } catch (e) {
                    console.error(e);
                    if (container) container.innerHTML = `<div class="text-red-400">Error: ${e.message}</div>`;
                }
            },

            renderIndicators(indicators) {
                if (!indicators) return '';
                const categories = {
                    trend: { title: 'Trend & Momentum', items: ['btc_price', 'btc_ema50', 'btc_ema200', 'btc_ema200_slope_pct_20'] },
                    volatility: { title: 'Volatility & Risk', items: ['btc_atrp_14_pct', 'btc_volume_z_50'] },
                    health: { title: 'Market Health', items: ['fear_greed_index', 'alt_breadth_above_ema50', 'funding_rate'] }
                };

                return Object.entries(categories).map(([key, cat]) => {
                    const catIndicators = indicators.filter(i => cat.items.includes(i.name));
                    const bullish = catIndicators.filter(i => i.signal === 'Bullish').length;
                    const pct = Math.round((bullish / catIndicators.length) * 100) || 0;

                    return `
                        <div class="glass-card rounded-2xl p-3">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-sm">${cat.title}</h3>
                                <span class="${pct > 50 ? 'text-emerald-400' : 'text-rose-400'} text-xs">${pct}%</span>
                            </div>
                            <div class="h-1.5 bg-gray-800 rounded-full overflow-hidden mb-2">
                                <div class="h-full ${pct > 50 ? 'bg-emerald-500' : 'bg-rose-500'}" 
                                    style="width: ${pct}%"></div>
                            </div>
                            <div class="space-y-1 text-xs">
                                ${catIndicators.map(ind => `
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">${ind.name}</span>
                                        <span class="${ind.signal === 'Bullish' ? 'text-emerald-400' :
                            ind.signal === 'Bearish' ? 'text-rose-400' : 'text-gray-400'}">
                                            ${typeof ind.value === 'number' ? ind.value.toFixed(2) : ind.value || 'N/A'}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            },

            // Lead-Lag ë¡œë”©
            async loadLeadLag() {
                const container = document.getElementById('lead-lag-section');
                if (!container) return;

                try {
                    const res = await fetch('/api/crypto/lead-lag');
                    const data = await res.json();

                    if (data.error) {
                        container.innerHTML = `<div class="text-red-400">${data.error}</div>`;
                        return;
                    }

                    const varMap = {
                        'TNX': 'ğŸ‡ºğŸ‡¸ 10ë…„ë¬¼ êµ­ì±„',
                        'TNX_MoM': 'ğŸ‡ºğŸ‡¸ 10ë…„ë¬¼ (MoM)',
                        'SPY': 'ğŸ‡ºğŸ‡¸ S&P 500',
                        'SPY_MoM': 'ğŸ‡ºğŸ‡¸ S&P 500 (MoM)',
                        'VIX': 'ğŸ«£ ê³µí¬ì§€ìˆ˜',
                        'VIX_MoM': 'ğŸ«£ ê³µí¬ì§€ìˆ˜ (MoM)',
                        'DXY': 'ğŸ’µ ë‹¬ëŸ¬ ì¸ë±ìŠ¤',
                        'DXY_MoM': 'ğŸ’µ ë‹¬ëŸ¬ (MoM)',
                        'GOLD': 'ğŸ¥‡ ê¸ˆ',
                        'GOLD_MoM': 'ğŸ¥‡ ê¸ˆ (MoM)',
                    };

                    container.innerHTML = `
                        <div class="glass-card rounded-3xl p-4">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h2 class="text-xl font-bold">Lead-Lag Analytics</h2>
                                    <p class="text-gray-500 text-sm">ë¹„íŠ¸ì½”ì¸ ì„ í–‰ ì§€í‘œ ë¶„ì„</p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${data.leading_indicators.slice(0, 6).map(item => {
                        const niceName = varMap[item.variable] || item.variable;
                        const isInverse = item.correlation < 0;
                        const strength = Math.abs(item.correlation) * 100;

                        return `
                                        <div class="glass-card rounded-2xl p-3">
                                            <div class="flex items-center gap-3 mb-2">
                                                <div class="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center text-xs font-bold">
                                                    ${item.lag}ì¼
                                                </div>
                                                <div>
                                                    <div class="font-bold text-sm">${niceName}</div>
                                                    <div class="text-xs text-gray-500">${item.variable}</div>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <div class="flex justify-between text-xs mb-1">
                                                    <span class="text-gray-500">ìƒê´€ê´€ê³„</span>
                                                    <span class="${isInverse ? 'text-rose-400' : 'text-emerald-400'}">
                                                        ${strength.toFixed(1)}%
                                                    </span>
                                                </div>
                                                <div class="h-1.5 bg-gray-800 rounded-full overflow-hidden">
                                                    <div class="h-full ${isInverse ? 'bg-rose-500' : 'bg-emerald-500'}" 
                                                        style="width: ${strength}%"></div>
                                                </div>
                                            </div>
                                            <div class="text-xs text-gray-400 bg-black/20 rounded-lg p-2 text-center">
                                                ${isInverse ? 'ğŸ“‰ ì§€í‘œ â†‘ â†’ BTC â†“' : 'ğŸ“ˆ ì§€í‘œ â†‘ â†’ BTC â†‘'}
                                            </div>
                                        </div>
                                    `;
                    }).join('')}
                            </div>
                        </div>
                    `;
                } catch (e) {
                    console.error(e);
                    if (container) container.innerHTML = `<div class="text-red-400">Error: ${e.message}</div>`;
                }
            },

            init() {
                this.loadMarketGate();
                this.loadLeadLag();
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // ... (ê¸°ì¡´ ì´ˆê¸°í™” ì½”ë“œ)

            // ========== ì½”ì¸ ê²€ìƒ‰ ê¸°ëŠ¥ (ëª¨ë“  ì½”ì¸ ì§€ì›) ==========
            let coinDatabase = [];  // ë™ì ìœ¼ë¡œ ë¡œë“œë¨

            // ë¹—ì¸ ê±°ë˜ì†Œ ê¸°ì¤€ ì½”ì¸ ë¡œë“œ (ë¹—ì¸ API ìš°ì„ , CoinGecko í´ë°±)
            async function loadCoinDatabase() {
                try {
                    // ë¹—ì¸ API - ëª¨ë“  ìƒì¥ ì½”ì¸ ì¡°íšŒ
                    const res = await fetch('https://api.bithumb.com/public/ticker/ALL_KRW');
                    const data = await res.json();

                    if (data.status === '0000' && data.data) {
                        const tickers = data.data;
                        const timestamp = tickers.date;
                        delete tickers.date; // date í•„ë“œ ì œê±°

                        coinDatabase = Object.keys(tickers).map(symbol => {
                            const coin = tickers[symbol];
                            return {
                                symbol: symbol.toUpperCase(),
                                name: getBithumbCoinName(symbol),
                                id: symbol.toLowerCase(),
                                sector: getSector(symbol.toLowerCase(), symbol.toUpperCase()),
                                price: parseFloat(coin.closing_price) || 0,
                                change: parseFloat(coin.fluctate_rate_24H) || 0,
                                volume: parseFloat(coin.acc_trade_value_24H) || 0,
                                exchange: 'Bithumb'
                            };
                        }).sort((a, b) => b.volume - a.volume); // ê±°ë˜ëŸ‰ìˆœ ì •ë ¬

                        console.log(`âœ… ë¹—ì¸ ${coinDatabase.length}ê°œ ì½”ì¸ ë¡œë“œ ì™„ë£Œ`);
                        return;
                    }
                    throw new Error('Bithumb API response not OK');

                } catch (bithumbErr) {
                    console.warn('ë¹—ì¸ API ì˜¤ë¥˜, CoinGecko ì‹œë„:', bithumbErr);

                    // í´ë°±: CoinGecko API
                    try {
                        const res = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=250&page=1&sparkline=false');
                        const data = await res.json();

                        coinDatabase = data.map(coin => ({
                            symbol: coin.symbol.toUpperCase(),
                            name: coin.name,
                            id: coin.id,
                            sector: getSector(coin.id, coin.symbol.toUpperCase()),
                            price: coin.current_price,
                            change: coin.price_change_percentage_24h || 0,
                            exchange: 'CoinGecko'
                        }));

                        console.log(`âœ… CoinGecko ${coinDatabase.length}ê°œ ì½”ì¸ ë¡œë“œ ì™„ë£Œ (í´ë°±)`);
                    } catch (cgErr) {
                        console.warn('CoinGeckoë„ ì‹¤íŒ¨, ê¸°ë³¸ ëª©ë¡ ì‚¬ìš©');
                        // ìµœì¢… í´ë°±: ë¹—ì¸ ì£¼ìš” ì½”ì¸ ëª©ë¡
                        coinDatabase = [
                            { symbol: 'BTC', name: 'ë¹„íŠ¸ì½”ì¸', sector: 'L1', exchange: 'Bithumb' },
                            { symbol: 'ETH', name: 'ì´ë”ë¦¬ì›€', sector: 'L1', exchange: 'Bithumb' },
                            { symbol: 'XRP', name: 'ë¦¬í”Œ', sector: 'L1', exchange: 'Bithumb' },
                            { symbol: 'SOL', name: 'ì†”ë¼ë‚˜', sector: 'L1', exchange: 'Bithumb' },
                            { symbol: 'DOGE', name: 'ë„ì§€ì½”ì¸', sector: 'Meme', exchange: 'Bithumb' },
                            { symbol: 'ADA', name: 'ì—ì´ë‹¤', sector: 'L1', exchange: 'Bithumb' },
                            { symbol: 'AVAX', name: 'ì•„ë°œë€ì²´', sector: 'L1', exchange: 'Bithumb' },
                            { symbol: 'DOT', name: 'í´ì¹´ë‹·', sector: 'L1', exchange: 'Bithumb' },
                            { symbol: 'LINK', name: 'ì²´ì¸ë§í¬', sector: 'DeFi', exchange: 'Bithumb' },
                            { symbol: 'MATIC', name: 'í´ë¦¬ê³¤', sector: 'L2', exchange: 'Bithumb' },
                            { symbol: 'SHIB', name: 'ì‹œë°”ì´ëˆ„', sector: 'Meme', exchange: 'Bithumb' },
                            { symbol: 'TRX', name: 'íŠ¸ë¡ ', sector: 'L1', exchange: 'Bithumb' },
                            { symbol: 'EOS', name: 'ì´ì˜¤ìŠ¤', sector: 'L1', exchange: 'Bithumb' },
                            { symbol: 'XLM', name: 'ìŠ¤í…”ë¼ë£¨ë©˜', sector: 'L1', exchange: 'Bithumb' },
                            { symbol: 'ETC', name: 'ì´ë”ë¦¬ì›€í´ë˜ì‹', sector: 'L1', exchange: 'Bithumb' },
                            { symbol: 'BCH', name: 'ë¹„íŠ¸ì½”ì¸ìºì‹œ', sector: 'L1', exchange: 'Bithumb' },
                            { symbol: 'SAND', name: 'ìƒŒë“œë°•ìŠ¤', sector: 'GameFi', exchange: 'Bithumb' },
                            { symbol: 'MANA', name: 'ë””ì„¼íŠ¸ëŸ´ëœë“œ', sector: 'GameFi', exchange: 'Bithumb' },
                            { symbol: 'AXS', name: 'ì—‘ì‹œì¸í”¼ë‹ˆí‹°', sector: 'GameFi', exchange: 'Bithumb' },
                            { symbol: 'HBAR', name: 'í—¤ë°ë¼', sector: 'L1', exchange: 'Bithumb' }
                        ];
                    }
                }
            }

            // ë¹—ì¸ ì½”ì¸ í•œê¸€ëª… ë§¤í•‘
            function getBithumbCoinName(symbol) {
                const names = {
                    'BTC': 'ë¹„íŠ¸ì½”ì¸', 'ETH': 'ì´ë”ë¦¬ì›€', 'XRP': 'ë¦¬í”Œ', 'SOL': 'ì†”ë¼ë‚˜',
                    'DOGE': 'ë„ì§€ì½”ì¸', 'ADA': 'ì—ì´ë‹¤', 'AVAX': 'ì•„ë°œë€ì²´', 'DOT': 'í´ì¹´ë‹·',
                    'LINK': 'ì²´ì¸ë§í¬', 'MATIC': 'í´ë¦¬ê³¤', 'SHIB': 'ì‹œë°”ì´ëˆ„', 'TRX': 'íŠ¸ë¡ ',
                    'EOS': 'ì´ì˜¤ìŠ¤', 'XLM': 'ìŠ¤í…”ë¼ë£¨ë©˜', 'ETC': 'ì´ë”ë¦¬ì›€í´ë˜ì‹', 'BCH': 'ë¹„íŠ¸ì½”ì¸ìºì‹œ',
                    'SAND': 'ìƒŒë“œë°•ìŠ¤', 'MANA': 'ë””ì„¼íŠ¸ëŸ´ëœë“œ', 'AXS': 'ì—‘ì‹œì¸í”¼ë‹ˆí‹°', 'HBAR': 'í—¤ë°ë¼',
                    'APT': 'ì•±í† ìŠ¤', 'ARB': 'ì•„ë¹„íŠ¸ëŸ¼', 'OP': 'ì˜µí‹°ë¯¸ì¦˜', 'SUI': 'ìˆ˜ì´',
                    'NEAR': 'ë‹ˆì–´í”„ë¡œí† ì½œ', 'ATOM': 'ì½”ìŠ¤ëª¨ìŠ¤', 'FIL': 'íŒŒì¼ì½”ì¸', 'LTC': 'ë¼ì´íŠ¸ì½”ì¸',
                    'UNI': 'ìœ ë‹ˆìŠ¤ì™‘', 'AAVE': 'ì—ì´ë¸Œ', 'MKR': 'ë©”ì´ì»¤', 'SNX': 'ì‹ ì„¸í‹±ìŠ¤',
                    'COMP': 'ì»´íŒŒìš´ë“œ', 'CRV': 'ì»¤ë¸Œ', 'SUSHI': 'ìŠ¤ì‹œìŠ¤ì™‘', 'YFI': 'ì—°íŒŒì´ë‚¸ìŠ¤',
                    'GRT': 'ë”ê·¸ë˜í”„', 'ENJ': 'ì—”ì§„ì½”ì¸', 'CHZ': 'ì¹ ë¦¬ì¦ˆ', 'KLAY': 'í´ë ˆì´íŠ¼',
                    'WEMIX': 'ìœ„ë¯¹ìŠ¤', 'STMX': 'ìŠ¤í†°ì—‘ìŠ¤', 'ANKR': 'ì•µì»¤', 'QTUM': 'í€€í…€',
                    'ZIL': 'ì§ˆë¦¬ì¹´', 'ICX': 'ì•„ì´ì½˜', 'ONT': 'ì˜¨í†¨ë¡œì§€', 'ZRX': 'ì œë¡œì—‘ìŠ¤',
                    'BAT': 'ë² ì´ì§ì–´í…ì…˜í† í°', 'THETA': 'ì„¸íƒ€í† í°', 'VET': 'ë¹„ì²´ì¸', 'NEO': 'ë„¤ì˜¤',
                    'WAVES': 'ì›¨ì´ë¸Œ', 'IOTA': 'ì•„ì´ì˜¤íƒ€', 'BTG': 'ë¹„íŠ¸ì½”ì¸ê³¨ë“œ', 'LOOM': 'ë£¸ë„¤íŠ¸ì›Œí¬'
                };
                return names[symbol.toUpperCase()] || symbol;
            }

            // ì„¹í„° ë¶„ë¥˜ í•¨ìˆ˜
            function getSector(id, symbol) {
                const sectors = {
                    // Meme
                    'dogecoin': 'Meme', 'shiba-inu': 'Meme', 'pepe': 'Meme', 'bonk': 'Meme',
                    'dogwifcoin': 'Meme', 'floki': 'Meme', 'baby-doge-coin': 'Meme',
                    // L2
                    'matic-network': 'L2', 'arbitrum': 'L2', 'optimism': 'L2', 'immutable-x': 'L2',
                    'polygon': 'L2', 'mantle': 'L2', 'base': 'L2',
                    // DeFi
                    'uniswap': 'DeFi', 'aave': 'DeFi', 'chainlink': 'DeFi', 'maker': 'DeFi',
                    'curve-dao-token': 'DeFi', 'lido-dao': 'DeFi', 'compound': 'DeFi',
                    // Exchange
                    'binancecoin': 'Exchange', 'okb': 'Exchange', 'kucoin-token': 'Exchange',
                    'crypto-com-chain': 'Exchange', 'leo-token': 'Exchange',
                    // GameFi
                    'the-sandbox': 'GameFi', 'decentraland': 'GameFi', 'axie-infinity': 'GameFi',
                    'gala': 'GameFi', 'enjincoin': 'GameFi', 'illuvium': 'GameFi',
                    // AI
                    'render-token': 'AI', 'fetch-ai': 'AI', 'singularitynet': 'AI',
                    'ocean-protocol': 'AI', 'bittensor': 'AI',
                    // Storage
                    'filecoin': 'Storage', 'arweave': 'Storage',
                };
                return sectors[id] || 'L1';
            }

            // ì´ˆê¸° ë¡œë“œ
            loadCoinDatabase();

            const searchInput = document.getElementById('coin-search-input');
            const searchResults = document.getElementById('search-results');
            const clearBtn = document.getElementById('search-clear-btn');
            let selectedIndex = -1;

            // ê²€ìƒ‰ ì…ë ¥ ì´ë²¤íŠ¸
            searchInput.addEventListener('input', function () {
                const query = this.value.trim().toUpperCase();

                if (query.length === 0) {
                    searchResults.classList.add('hidden');
                    clearBtn.classList.add('hidden');
                    return;
                }

                clearBtn.classList.remove('hidden');

                // ê²€ìƒ‰ í•„í„°ë§
                const filtered = coinDatabase.filter(coin =>
                    coin.symbol.includes(query) ||
                    coin.name.toUpperCase().includes(query)
                ).slice(0, 10);

                if (filtered.length === 0) {
                    searchResults.innerHTML = `
                        <div class="p-3 text-gray-400 text-sm">
                            <div>ëª©ë¡ì— ì—†ëŠ” ì½”ì¸ì…ë‹ˆë‹¤</div>
                            <div class="mt-2 flex items-center gap-2">
                                <span class="text-purple-400 font-bold">${query}</span>
                                <span class="text-xs">â† Enter í‚¤ë¥¼ ëˆ„ë¥´ë©´ ì§ì ‘ ê²€ìƒ‰</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">ëª¨ë“  TradingView ì§€ì› ì½”ì¸ ê²€ìƒ‰ ê°€ëŠ¥</div>
                        </div>`;
                } else {
                    searchResults.innerHTML = filtered.map((coin, idx) => `
                        <div class="search-result-item px-3 py-2 hover:bg-gray-800 cursor-pointer flex items-center gap-2 ${idx === selectedIndex ? 'bg-gray-800' : ''}" 
                             data-symbol="${coin.symbol}" data-index="${idx}">
                            <span class="font-bold text-white">${coin.symbol}</span>
                            <span class="text-gray-400 text-sm">${coin.name}</span>
                            <span class="ml-auto text-xs px-2 py-0.5 rounded bg-gray-700 text-gray-300">${coin.sector}</span>
                        </div>
                    `).join('');
                }

                searchResults.classList.remove('hidden');
            });

            // ê²€ìƒ‰ ê²°ê³¼ í´ë¦­
            searchResults.addEventListener('click', function (e) {
                const item = e.target.closest('.search-result-item');
                if (item) {
                    const symbol = item.dataset.symbol;
                    selectCoinFromSearch(symbol);
                }
            });

            // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
            searchInput.addEventListener('keydown', function (e) {
                const items = searchResults.querySelectorAll('.search-result-item');

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSearchSelection(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, 0);
                    updateSearchSelection(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedIndex >= 0 && items[selectedIndex]) {
                        const symbol = items[selectedIndex].dataset.symbol;
                        selectCoinFromSearch(symbol);
                    } else if (this.value.trim()) {
                        // ì§ì ‘ ì…ë ¥í•œ ì‹¬ë³¼ë¡œ ê²€ìƒ‰
                        selectCoinFromSearch(this.value.trim().toUpperCase());
                    }
                } else if (e.key === 'Escape') {
                    searchResults.classList.add('hidden');
                    selectedIndex = -1;
                }
            });

            // ì„ íƒ í•˜ì´ë¼ì´íŠ¸ ì—…ë°ì´íŠ¸
            function updateSearchSelection(items) {
                items.forEach((item, idx) => {
                    if (idx === selectedIndex) {
                        item.classList.add('bg-gray-800');
                    } else {
                        item.classList.remove('bg-gray-800');
                    }
                });
            }

            // ê²€ìƒ‰ì—ì„œ ì½”ì¸ ì„ íƒ
            function selectCoinFromSearch(symbol) {
                searchInput.value = symbol;
                searchResults.classList.add('hidden');
                selectedIndex = -1;

                // selectCoin í•¨ìˆ˜ í˜¸ì¶œ (TradingView, íŒŒë™ ë¶„ì„, AI ë¶„ì„ ì—°ë™)
                selectCoin(symbol);

                // ì„±ê³µ í”¼ë“œë°±
                searchInput.style.borderColor = '#22c55e';
                setTimeout(() => {
                    searchInput.style.borderColor = '';
                }, 1000);
            }

            // í´ë¦¬ì–´ ë²„íŠ¼
            clearBtn.addEventListener('click', function () {
                searchInput.value = '';
                searchResults.classList.add('hidden');
                clearBtn.classList.add('hidden');
                selectedIndex = -1;
            });

            // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
            document.addEventListener('click', function (e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.add('hidden');
                    selectedIndex = -1;
                }
            });

            // í¬ì»¤ìŠ¤ ì‹œ ì´ì „ ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
            searchInput.addEventListener('focus', function () {
                if (this.value.trim().length > 0) {
                    searchResults.classList.remove('hidden');
                }
            });

            // ========== ê¸°ì¡´ íƒ­ ë²„íŠ¼ ì´ë²¤íŠ¸ ==========
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const tabName = this.dataset.tab;

                    // ë²„íŠ¼ í™œì„±í™”
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // íƒ­ ì½˜í…ì¸  ì „í™˜ logic

                    // ëª¨ë“  íƒ­ ìˆ¨ê¸°ê¸°
                    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));

                    if (tabName === 'report') {
                        // AI ë¦¬í¬íŠ¸ íƒ­ í‘œì‹œ
                        document.getElementById('tab-report').classList.add('active');
                        initLayerChart();
                        loadExpertAnalysis();
                    } else if (tabName === 'analysis') {
                        // ì‹œì¥ ë¶„ì„ íƒ­ í‘œì‹œ
                        document.getElementById('tab-analysis').classList.add('active');
                        MarketAnalysis.init();
                    } else {
                        // íŠ¸ë ˆì´ë”© íƒ­ (í†µí•© ë·°) í‘œì‹œ
                        document.getElementById('dashboard-view').classList.add('active');

                        // ë°ì´í„° ë¦¬ë¡œë“œ
                        currentTimeframe = tabName;
                        loadRankings(tabName);

                        // ì°¨íŠ¸ ì¸í„°ë²Œ ë³€ê²½
                        initTradingView(selectedCoin, tabName); // í˜„ì¬ ì„ íƒëœ ì½”ì¸ì˜ ì¸í„°ë²Œ ë³€ê²½

                        // ì •ë ¬ ê¸°ì¤€ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                        const sortText = {
                            'scalp': 'ìƒìŠ¹ëŸ‰ â†’ ê±°ë˜ëŸ‰ â†’ NICE',
                            'short': 'ì¶”ì„¸ê°•ë„ â†’ NICE ì ìˆ˜',
                            'medium': 'NICE ì ìˆ˜ â†’ ê³ ë˜ í¬ì§€ì…˜',
                            'long': 'ì‹œê°€ì´ì•¡ â†’ ê¸°ê´€ ì ìˆ˜'
                        };
                        document.getElementById('major-sort-criteria').textContent = sortText[tabName] || 'ìƒìŠ¹ëŸ‰ â†’ ê±°ë˜ëŸ‰';
                    }
                });
            });

            // ì´ˆê¸° ë¡œë“œ
            loadRankings('scalp');
            loadHeaderData();
            initTradingView('BTC', 'scalp');
            renderMarketMap();

            // í—¤ë” ìë™ ê°±ì‹  (30ì´ˆë§ˆë‹¤)
            setInterval(loadHeaderData, 30000);

            // íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }) + ' ê°±ì‹ ';
        });
    </script>

    <!-- API Key ì„¤ì • ëª¨ë‹¬ -->
    <div id="api-key-modal" class="modal-overlay" style="z-index: 9999;">
        <div class="modal-content glass-card" style="max-width: 500px;">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                ğŸ”‘ API í‚¤ ì„¤ì • (í•„ìˆ˜)
                <span class="text-xs text-red-400 font-normal">* Render í™˜ê²½ ë³€ìˆ˜ ì—°ë™</span>
            </h3>
            <p class="text-sm text-gray-400 mb-6">
                NICE ëª¨ë¸ê³¼ AI ë¶„ì„ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•´ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.<br>
                ì…ë ¥ëœ í‚¤ëŠ” ì„œë²„ ë©”ëª¨ë¦¬ì— ì„ì‹œ ì €ì¥ë˜ê±°ë‚˜ Render í™˜ê²½ ë³€ìˆ˜ì™€ ì—°ë™ë©ë‹ˆë‹¤.
            </p>

            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-400 mb-1 block">Perplexity API Key (ì‹¤ì‹œê°„ ì‹œì¥ ë¶„ì„ìš©)</label>
                    <input type="password" id="input-perplexity-key" placeholder="pplx-..."
                        class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white">
                </div>
                <div>
                    <label class="text-xs text-gray-400 mb-1 block">OpenAI API Key (GPT ë¶„ì„ìš©)</label>
                    <input type="password" id="input-openai-key" placeholder="sk-..."
                        class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white">
                </div>
                <div>
                    <label class="text-xs text-gray-400 mb-1 block">Gemini API Key (ë³´ì¡° ë¶„ì„ìš©)</label>
                    <input type="password" id="input-gemini-key" placeholder="AIza..."
                        class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white">
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-6">
                <button onclick="document.getElementById('api-key-modal').classList.remove('active')"
                    class="px-4 py-2 bg-gray-600 rounded text-gray-300 font-bold text-sm">ë‹«ê¸° (ê¸°ëŠ¥ ì œí•œ)</button>
                <button onclick="saveApiKeys()"
                    class="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 rounded text-white font-bold text-sm">ì„¤ì • ì €ì¥ ë°
                    ì—°ê²°</button>
            </div>
        </div>
    </div>

    <!-- ë¹—ì¸ ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ (ë™ì  ìƒì„±) -->
    <template id="bithumb-list-template">
        <div class="glass-card p-3">
            <h3 class="font-bold text-lg mb-3 text-orange-400">ğŸ‡°ğŸ‡· ë¹—ì¸(Bithumb) ì´ˆë‹¨íƒ€ ë¦¬ìŠ¤íŠ¸</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="text-gray-400 text-xs uppercase bg-gray-800/50">
                        <tr>
                            <th class="px-2 py-2">ì½”ì¸ëª…</th>
                            <th class="px-2 py-2 text-right">í˜„ì¬ê°€</th>
                            <th class="px-2 py-2 text-right">ë³€ë™ë¥ (24h)</th>
                            <th class="px-2 py-2 text-right">ê±°ë˜ëŸ‰</th>
                            <th class="px-2 py-2 text-center">NICE ì ìˆ˜</th>
                        </tr>
                    </thead>
                    <tbody id="bithumb-table-body" class="divide-y divide-gray-700">
                        <!-- JSë¡œ ì±„ì›€ -->
                    </tbody>
                </table>
            </div>
        </div>
    </template>

    <script>
        // API í‚¤ í™•ì¸ ë° ëª¨ë‹¬ ì œì–´
        async function checkApiKeys() {
            try {
                const res = await fetch('/api/admin/config');
                const keys = await res.json();

                // í‚¤ê°€ í•˜ë‚˜ë¼ë„ ì—†ìœ¼ë©´ ëª¨ë‹¬ ë„ì›€
                if (!keys.perplexity && !keys.openai) {
                    document.getElementById('api-key-modal').classList.add('active');
                }
            } catch (e) {
                console.error('API Key check failed:', e);
            }
        }

        async function saveApiKeys() {
            const perplexity = document.getElementById('input-perplexity-key').value;
            const openai = document.getElementById('input-openai-key').value;
            const gemini = document.getElementById('input-gemini-key').value;

            try {
                const res = await fetch('/api/admin/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        perplexity_key: perplexity,
                        openai_key: openai,
                        gemini_key: gemini
                    })
                });

                const result = await res.json();
                if (result.status === 'success') {
                    showToast('âœ… API í‚¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    document.getElementById('api-key-modal').classList.remove('active');
                    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì ìš©
                    window.location.reload();
                } else {
                    showToast('âŒ ì„¤ì • ì‹¤íŒ¨: ' + result.error, 'error');
                }
            } catch (e) {
                showToast('âŒ í†µì‹  ì˜¤ë¥˜', 'error');
            }
        }

        // ë¹—ì¸ íƒ­ ë¡œì§ ì¶”ê°€
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.dataset.tab === 'bithumb') {
                    // ê¸°ì¡´ ë¡œì§(íƒ­ í™œì„±í™”)ì€ common.js ë“±ì— ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ UI ì²˜ë¦¬ë§Œ ì¶”ê°€
                    // ì‹¤ì œ ë°ì´í„° ë¡œë“œëŠ” loadRankings ë“±ì´ ìˆ˜í–‰
                    document.getElementById('major-coins-list').parentElement.querySelector('h3').textContent = 'ğŸ‡°ğŸ‡· ë¹—ì¸ ë©”ì´ì €';
                }
            });
        });

        // ì´ˆê¸° ì‹¤í–‰ ì‹œ ëª¨ë‹¬ ì²´í¬
        document.addEventListener('DOMContentLoaded', () => {
            checkApiKeys();
        });

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ (Ctrl+K)ë¡œ ëª¨ë‹¬ ì—´ê¸°
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                document.getElementById('api-key-modal').classList.add('active');
            }
        });
    </script>
</body>


</html>